/**** game/ColorGroups.js_ ****/
var ColorGroups;!function(){"use strict";ColorGroups={multiple_villages_link:null,TYPE_OWN:"own",TYPE_OTHER:"other",init:function(e,o){if(this.color_picker.base_link=e,this.multiple_villages_link=o,MapLegend.init(),$(".colorgroup-own-activate").change(function(){var e=$(this),o=e.closest(".colorgroup-own-entry").data("id");e.is(":checked")?ColorGroups.Own.activateGroup(o):ColorGroups.Own.deactivateGroup(o)}),$(".colorgroup-other-activate").change(function(){var e=$(this),o=e.closest(".colorgroup-other-entry").data("id");e.is(":checked")?ColorGroups.Other.activateGroup(o):ColorGroups.Other.deactivateGroup(o)}),$(".colorgroup-own-delete").on("click",function(e){e.preventDefault();var o=$(this).closest(".colorgroup-own-entry").data("id");UI.addConfirmBox(_("1d7a209e5461c92be4a38e7cfef02380"),function(){ColorGroups.Own.deleteGroup(o)})}),$(".colorgroup-other-delete").on("click",function(e){e.preventDefault();var o=$(this).closest(".colorgroup-other-entry").data("id");UI.addConfirmBox(_("1d7a209e5461c92be4a38e7cfef02380"),function(){ColorGroups.Other.deleteGroup(o)})}),$(".colorgroup-own-entry").find(".color_picker_launcher").click(function(e){e.preventDefault(),ColorGroups.color_picker.openPopup($(this),ColorGroups.TYPE_OWN)}),$(".colorgroup-other-entry").find(".color_picker_launcher").click(function(e){e.preventDefault(),ColorGroups.color_picker.openPopup($(this),ColorGroups.TYPE_OTHER)}),$(".own-group-create-btn").on("click",this.Own.toggleCreation),$(".other-group-create-btn").on("click",this.Other.startCreation),mobile){var a=TribalWars.buildURL("POST","map",{ajaxaction:"change_group_order"});MDS.orderableQueue.init($("#color-groups-queue"),a,function(e){UI.SuccessMessage(e.message)},!1)}else $("#own_color_groups").sortable({axis:"y",handle:".bqhandle",helper:function(e,o){var a=o.children(),r=o.clone();return r.children().each(function(e){$(this).width(a.eq(e).width())}),r},items:".colorgroup-own-entry",placeholder:"table_row_placeholder",stop:function(e,o){TribalWars.post("map",{ajaxaction:"change_group_order"},$("#own_color_groups").sortable("serialize"),function(e){UI.SuccessMessage(e.message)},function(){$("#own_color_groups").sortable("cancel")})}})},openMultiVillagePopup:function(e){TribalWars.post("map",{ajaxaction:"load_for_multiple_villages"},{},function(e){Dialog.show("multi_village_popup",e.dialog,null,{width:400})})},color_picker:{base_link:null,r:0,g:0,b:0,group_id:null,group_type:null,icon:null,openPopup:function(e,o){var a=e.offset().left+50,r=e.offset().top-100,l=e.data("id"),i=e.data("r"),t=e.data("g"),n=e.data("b"),c=e.data("icon"),p=e.data("t"),s=this.base_link+"&r="+i+"&g="+t+"&b="+n;p&&(s+="&trans="+p),this.r=i,this.g=t,this.b=n,this.group_id=l,this.group_type=o,this.icon=c,UI.AjaxPopup(null,"edit_color_popup",s,_("703ddad7cc7f884b4ebf6b79dac842e6"),this.handleReload,{dataType:"html",reload:!0},!1,!1,a,r)},handleReload:function(e,o){var a=ColorGroups.color_picker;$(o).html(e),$("#color_picker").show(),$("#color_group_id").val(a.group_id),$("#icon_url").val(a.icon),color_picker_choose(a.r,a.g,a.b,!0),$("#trans_color_input").attr("checked")&&$("#color").css("background-color","transparent"),a.group_type===ColorGroups.TYPE_OTHER?($("#icon_picker").hide(),$("#trans_color").hide(),$("#color_picker_submit").val(_("c9cc8cce247e49bae79f15173ce97354")),$("#editcolorform").submit(function(e){e.preventDefault(),ColorGroups.Other.changeColor(a.group_id,$("#color_picker_r").val(),$("#color_picker_g").val(),$("#color_picker_b").val()),$("#closelink_edit_color_popup").click()})):($("#color_picker_submit").val(_("c9cc8cce247e49bae79f15173ce97354")),$("#editcolorform").submit(function(e){e.preventDefault(),ColorGroups.Own.changeColor(a.group_id,parseInt($("#color_picker_r").val()),parseInt($("#color_picker_g").val()),parseInt($("#color_picker_b").val()),$("#icon_url").val(),$("#trans_color_input").is(":checked")),$("#closelink_edit_color_popup").click()}))}},Own:{groups:{},toggleCreation:function(e){e.preventDefault();var o=$("#own_villages");o.toggle();var a=0,r=0,l=null;if(l=e.srcElement?e.srcElement:e.target,$.cookie("popup_pos_own_villages")){var i=$.cookie("popup_pos_own_villages").split("x");a=parseInt(i[0],10),r=parseInt(i[1],10)}else a=$(l).offset().left,r=$(l).offset().top-o.height()-5;o.offset({left:a,top:r}),UI.Draggable(o)},activateGroup:function(e){TribalWars.post("map",{ajaxaction:"marker_active"},{group_id:e,active:1},function(o){MapLegend.showHighlight(MapLegend.CATEGORY_OWN,e);for(var a=ColorGroups.Own.groups[e].villages,r=0;r<a.length;r++)TWMap.villageIcons.hasOwnProperty(a[r])||(TWMap.villageIcons[a[r]]={}),TWMap.villageIcons[a[r]]["group_"+e]=ColorGroups.Own.groups[e].marker;TWMap.map.reload(!0)})},deactivateGroup:function(e){TribalWars.post("map",{ajaxaction:"marker_active"},{group_id:e,active:0},function(o){MapLegend.hideHighlight(MapLegend.CATEGORY_OWN,e);for(var a=ColorGroups.Own.groups[e].villages,r=0;r<a.length;r++)delete TWMap.villageIcons[a[r]]["group_"+e];TWMap.map.reload(!0)})},deleteGroup:function(e){TribalWars.post("map",{ajaxaction:"marker_delete"},{group_id:e},function(o){$('.colorgroup-own-entry[data-id="'+e+'"]').remove(),MapLegend.removeHighlight(MapLegend.CATEGORY_OWN,e);for(var a=ColorGroups.Own.groups[e].villages,r=0;r<a.length;r++)delete TWMap.villageIcons[a[r]]["group_"+e];TWMap.map.reload(!0),delete ColorGroups.Own.groups[e]})},changeColor:function(e,o,a,r,l,i){TribalWars.post("map",{ajaxaction:"marker_change"},{group_id:e,r:o,g:a,b:r,icon_url:l,t:i},function(t){MapLegend.updateHighlight(MapLegend.CATEGORY_OWN,e,null,i?null:{r:o,g:a,b:r},l);var n=i?"none":"rgb("+o+","+a+","+r+")",c=l?escapeHtml(l,!0):"",p=$('.colorgroup-own-entry[data-id="'+e+'"]');p.find(".marker").css("background-color",n),""!==c&&p.find(".marker").css({backgroundSize:"cover",backgroundImage:"url("+c+")"}),p.find(".color_picker_launcher").data("r",o).data("g",a).data("b",r).data("icon",l).data("t",i),ColorGroups.Own.groups[e].marker.c=n,ColorGroups.Own.groups[e].marker.img=l;for(var s=ColorGroups.Own.groups[e].villages,g=0;g<s.length;g++)TWMap.villageIcons[s[g]]["group_"+e]=ColorGroups.Own.groups[e].marker;TWMap.map.reload(!0)})}},Other:{startCreation:function(){$("#new_group").show()},activateGroup:function(e){TribalWars.post("map",{ajaxaction:"colorgroup_active"},{group_id:e,active:1},function(o){MapLegend.showHighlight(MapLegend.CATEGORY_OTHER,e),ColorGroups.Other.handleBigChange(o)})},deactivateGroup:function(e){TribalWars.post("map",{ajaxaction:"colorgroup_active"},{group_id:e,active:0},function(o){MapLegend.hideHighlight(MapLegend.CATEGORY_OTHER,e),ColorGroups.Other.handleBigChange(o)})},deleteGroup:function(e){TribalWars.post("map",{ajaxaction:"colorgroup_delete"},{group_id:e},function(o){$("#for_groups").find('.colorgroup-other-entry[data-id="'+e+'"]').remove(),MapLegend.removeHighlight(MapLegend.CATEGORY_OTHER,e),ColorGroups.Other.handleBigChange(o)})},changeColor:function(e,o,a,r){TribalWars.post("map",{ajaxaction:"colorgroup_change_color"},{group_id:e,r:o,g:a,b:r},function(l){MapLegend.updateHighlight(MapLegend.CATEGORY_OTHER,e,l.group_name,{r:o,g:a,b:r}),ColorGroups.Other.handleBigChange(l);var i=$('.colorgroup-other-entry[data-id="'+e+'"]');i.find(".marker").css("background-color","rgb("+o+","+a+","+r+")"),i.find(".color_picker_launcher").data("r",o).data("g",a).data("b",r)})},handleBigChange:function(e){MapHighlighter.alterAll(e.village_colors,e.player_colors,e.tribe_colors),MapHighlighter.colorAll(e.affected_villages,e.affected_players,e.affected_tribes),TWMap.minimap_cache_stamp++,TWMap.minimap.reload(!0),TWMap.map.reload(!0)},editor:{ENTITY_TRIBE:"ally",ENTITY_PLAYER:"player",ENTITY_VILLAGE:"village",group_id:null,group_name:null,openPopup:function(e,o,a){ColorGroups.Other.editor;this.group_id=o,this.group_name=unescapeHtml($("#groupname_"+o).html()),TribalWars.post("map",{ajaxaction:"load_for_groups"},{},function(e){Dialog.show("for_villages_popup",e.dialog,null,{width:400})})},handleReload:function(e,o){var a=ColorGroups.Other.editor;$("#for_villages_popup_content").html(e),$("#for_group_id").val(a.group_id),$("#for_group_name").val(a.group_name),a.fetchGroupMembers(a.ENTITY_TRIBE),a.fetchGroupMembers(a.ENTITY_PLAYER),a.fetchGroupMembers(a.ENTITY_VILLAGE),UI.init()},fetchGroupMembers:function(e){var o=this,a="",r=null;e===o.ENTITY_TRIBE&&(a="colorgroup_get_tribes",r=$("#tribes > tbody")),e===o.ENTITY_PLAYER&&(a="colorgroup_get_players",r=$("#players > tbody")),e===o.ENTITY_VILLAGE&&(a="colorgroup_get_villages",r=$("#villages > tbody")),TribalWars.post("map",{ajaxaction:a},{group_id:o.group_id},function(a){r.empty(),$(a).each(function(a,l){var i=$("<tr>"),t="",n=escapeHtml(l.name);e===o.ENTITY_TRIBE&&(t='<img src="'+l.ally_image+'" class="userimage-tiny"> ',n+=" ["+escapeHtml(l.tag)+"]"),e===o.ENTITY_PLAYER&&(t='<img src="'+l.player_image+'" class="userimage-tiny"> ');var c=$("<td>").html(t+n),p=$("<a>").attr("href","#").html(_("099af53f601532dbd31e0ea99ffdeb64")).click(function(){return o.removeMember(e,l.id),!1}),s=$("<td>").append(p);i.append(c),i.append(s),r.append(i)}),e===o.ENTITY_VILLAGE&&(a.length>0?$("#toggle_villages_link").show():$("#toggle_villages_link").hide())})},ajax_request:function(e,o,a,r){var l=ColorGroups.Other.editor,i=$.extend({group_id:l.group_id},o);TribalWars.post("map",{ajaxaction:"colorgroup_"+e},i,function(e){a===l.ENTITY_TRIBE&&l.fetchGroupMembers(l.ENTITY_TRIBE),a===l.ENTITY_PLAYER&&l.fetchGroupMembers(l.ENTITY_PLAYER),a===l.ENTITY_VILLAGE&&(l.fetchGroupMembers(l.ENTITY_VILLAGE),$("#add_village_x").val(""),$("#add_village_y").val("")),"function"==typeof r&&r(e)})},toggleVillageList:function(){$("#villages").slideToggle("fast")},renameGroup:function(e){var o=this;o.ajax_request("rename",{name:e},null,function(a){$("#groupname_"+o.group_id).html(escapeHtml(e)),void 0!==TWMap.villageKey[a.village_id]&&MapLegend.updateHighlight(MapLegend.CATEGORY_OTHER,o.group_id,e,a.color),UI.SuccessMessage(_("996bf1c7776f50b7afe7e50fdc04b32b"))})},addTribe:function(e){this.ajax_request("add_tribe",{name:e},this.ENTITY_TRIBE,function(e){$("#new_tribe").val("").focus(),MapHighlighter.alterAlly(e.ally_id,e.color),MapHighlighter.colorAlly(e.ally_id),TWMap.minimap_cache_stamp++,TWMap.minimap.reload(!0),UI.SuccessMessage(_("c6c2c06d456fb88bc5bddf420e7dca41"))})},removeTribe:function(e){this.ajax_request("del_tribe",{id:e},this.ENTITY_TRIBE,function(o){MapHighlighter.alterAlly(e,o.color),MapHighlighter.colorAlly(e),TWMap.minimap_cache_stamp++,TWMap.minimap.reload(!0),UI.SuccessMessage(_("db8cf2906e1249b98eac8dd0c5e51a09"))})},addPlayer:function(e){this.ajax_request("add_player",{name:e},this.ENTITY_PLAYER,function(e){$("#new_player").val("").focus(),MapHighlighter.alterPlayer(e.player_id,e.color),MapHighlighter.colorPlayer(e.player_id),TWMap.minimap_cache_stamp++,TWMap.minimap.reload(!0),UI.SuccessMessage(_("55aa86def5c494c49b7a93d1e1c70441"))})},removePlayer:function(e){this.ajax_request("del_player",{id:e},this.ENTITY_PLAYER,function(o){MapHighlighter.alterPlayer(e,o.color),MapHighlighter.colorPlayer(e),TWMap.minimap_cache_stamp++,TWMap.minimap.reload(!0),UI.SuccessMessage(_("00f3700f9bbb1b1db7437abe2a7ab43f"))})},addVillage:function(e,o){this.ajax_request("add_village",{x:e,y:o},this.ENTITY_VILLAGE,function(e){$("#add_vilage_x").focus(),MapHighlighter.alterVillage(e.village_id,e.color),void 0!==TWMap.villageKey[e.village_id]&&MapHighlighter.colorVillage(TWMap.villages[TWMap.villageKey[e.village_id]]),TWMap.minimap_cache_stamp++,TWMap.minimap.reload(!0),UI.SuccessMessage(_("5a3e017d872f44bd1505bfcde72bb151"))})},addMutipleVillages:function(e){this.ajax_request("add_multiple_villages",{coordinates:e},this.ENTITY_VILLAGE,function(e){e.villages.forEach(function(e){MapHighlighter.alterVillage(e.village_id,e.color),void 0!==TWMap.villageKey[e.village_id]&&MapHighlighter.colorVillage(TWMap.villages[TWMap.villageKey[e.village_id]]),TWMap.minimap_cache_stamp++}),TWMap.minimap.reload(!0),e.status?UI.SuccessMessage(_("8a144eaccab2a0ca9543e944be380b1c")):UI.ErrorMessage(e.message),Dialog.close()})},removeVillage:function(e){this.ajax_request("del_village",{id:e},this.ENTITY_VILLAGE,function(o){MapHighlighter.alterVillage(e,o.color),void 0!==TWMap.villageKey[e]&&MapHighlighter.colorVillage(TWMap.villages[TWMap.villageKey[e]]),TWMap.minimap_cache_stamp++,TWMap.minimap.reload(!0),UI.SuccessMessage(_("d7682f8d88b683452c73ec1b46b1e0d4"))})},removeMember:function(e,o){switch(e){case this.ENTITY_TRIBE:this.removeTribe(o);break;case this.ENTITY_PLAYER:this.removePlayer(o);break;case this.ENTITY_VILLAGE:this.removeVillage(o);break;default:return}}}}}}();

;/**** game/freemap.js ****/
function FreeMap(e,t,i,s,o){var n=this;if(this.el={},this.el.root=e,this.el.container=document.createElement("div"),$(this.el.container).attr("style","position: absolute; left:0px; top:0px; z-index:1; overflow:visible"),this.el.container.setAttribute("id",e.id+"_container"),e.appendChild(this.el.container),this.size=[$(e).width(),$(e).height()],this.scale=t,this.sectorSize=i,this.pos=[-1,-1],this.handler=s,s.onClick){var r=this;$.browser.msie?$(this.el.root).mousedown(function(e){r._downEl=2==e.which?0:1}).mouseup(function(e){return 1!=r._downEl||r._handleClick(e)?(r._downEl=0,!0):(r._downEl=2,!1)}).click(function(e){if(2==r._downEl)return!1}):$(this.el.root).click(function(e){return 2==e.which||r._handleClick(e)})}return this._lastTopLeftSector=[0,0],this._lastBottomRightSector=[0,0],this._visibleSectors={},this._loadedSectors={},this.viewport=[0,0,0,0],this.bias=o,this._handleClick=function(e){if(this.mover&&this.mover.moveDirty)return!1;var t=this.coordByEvent(e);return this.handler.onClick(t[0],t[1],e)},this.coordByPixel=function(e,t,i){return!0===i?[e/this.scale[0],t/this.scale[1]]:[Math.floor(e/this.scale[0]),Math.floor(t/this.scale[1])]},this.pixelByCoord=function(e,t){return[e*this.scale[0],t*this.scale[1]]},this.sectorByPixel=function(e,t){return[Math.floor(e/this.scale[0]/this.sectorSize),Math.floor(t/this.scale[1]/this.sectorSize)]},this.coordByEvent=function(e){var t=$(this.el.root).offset(),i=[e.pageX-t.left+this.pos[0],e.pageY-t.top+this.pos[1]];return[Math.floor(i[0]/this.scale[0]),Math.floor(i[1]/this.scale[1])]},this.centerPos=function(e,t,i){var s=e*this.scale[0]-this.size[0]/2+this.scale[0]/2,o=t*this.scale[1]-this.size[1]/2+this.scale[1]/2;return!0===i&&(s-=s%this.scale[0],o-=o%this.scale[1]),this.setPosPixel(s,o)},this.setPos=function(e,t){return this.setPosPixel(e*this.scale[0],t*this.scale[1])},this.setPosPixel=function(e,t){if(e==this.pos[0]&&t==this.pos[1])return 0;if(isNaN(e)||isNaN(t))return 0;var i=this.handler.scrollBound.x_min*this.scale[0],s=this.handler.scrollBound.x_max*this.scale[0]-this.size[0]+this.scale[0];e=Math.min(Math.max(e,i),s);var o=this.handler.scrollBound.y_min*this.scale[1],r=this.handler.scrollBound.y_max*this.scale[1]-this.size[1]+this.scale[1];t=Math.min(Math.max(t,o),r),this.pos[0]=e,this.pos[1]=t,this.handler.onMovePixel&&this.handler.onMovePixel(e,t);var h=0,a=[e+this.size[0],t+this.size[1]],l=this.sectorByPixel(e,t),d=this.sectorByPixel(a[0],a[1]);if(!compareCoord(this._lastTopLeftSector,l)||!compareCoord(this._lastBottomRightSector,d)){for(var c=[],u=[],p=l[0];p<=d[0];p++)for(var v=l[1];v<=d[1];v++){var m=p+"_"+v;if(!(M=this._loadedSectors[m])){M={id:m,visible:!1,loaded:!0,sx:p,sy:v,x:p*this.sectorSize,y:v*this.sectorSize,_elements:[],_element_root:null,_map:n,appendElement:function(e,t,i){e.style.left=t*this._map.scale[0]+"px",e.style.top=i*this._map.scale[1]+"px",this._elements.push(e),void 0===this.dom_fragment?this._element_root.appendChild(e):this.dom_fragment.appendChild(e)},spawn:function(){this.visible||(this._map.el.container.appendChild(this._element_root),this.visible=!0)},despawn:function(e){this.visible&&(this._map.el.container.removeChild(this._element_root),!0===e&&(this._element_root=null),this.visible=!1)}};var _=document.createElement("div");_.style.width=this.scale[0]*this.sectorSize+"px",_.style.height=this.scale[1]*this.sectorSize+"px",_.style.position="absolute",_.style.left=p*this.sectorSize*this.scale[0]-this.bias+"px",_.style.top=v*this.sectorSize*this.scale[1]-this.bias+"px",M._element_root=_,M.spawn(),(!this.handler.scrollBound||M.x>=this.handler.scrollBound.x_min-this.sectorSize&&M.y>=this.handler.scrollBound.y_min-this.sectorSize&&M.x<this.handler.scrollBound.x_max&&M.y<this.handler.scrollBound.y_max)&&u.push(M)}c.push(M)}if(u.length)if(h=u.length,this.handler.loadSectors)this.handler.loadSectors(u);else for(var g=0;g<h;g++)this.handler.loadSector(u[g]);if(c.length){this.handler.preLoad&&this.handler.preLoad(c.length);var f={},w=c.length;for(g=0;g<w;g++){var M;(M=c[g]).loaded&&M.spawn(),f[M.id]=M,this._loadedSectors[M.id]=M}for(var g in this._visibleSectors)if(this._visibleSectors.hasOwnProperty(g)){var x=this._visibleSectors[g];void 0===f[x.id]&&(x.despawn(),delete this._loadedSectors[g])}this.handler.postLoad&&this.handler.postLoad(),this._visibleSectors=f}}var y=this.getCenter();return this.lastCenterCoordPos&&compareCoord(y,this.lastCenterCoordPos)||(this.handler.onMove&&this.handler.onMove(y[0],y[1]),this.lastCenterCoordPos=y,this.recalcViewport()),e-=this.bias,t-=this.bias,this.el.container.style.left=-e+"px",this.el.container.style.top=-t+"px",h},this.getCenter=function(){return this.coordByPixel(this.pos[0]+this.size[0]/2,this.pos[1]+this.size[1]/2)},this.getLevelForVillagePoints=function(e){for(var t=[300,1e3,3e3,9e3,11e3],i=1,s=0;s<t.length&&!(e<t[s]);s++)i++;return i},this.getViewportTileDimensions=function(){return{width:TWMap.map.size[0]/TWMap.map.scale[0],height:TWMap.map.size[1]/TWMap.map.scale[1]}},this.getViewport=function(){return{top_left_tile:{coord_x:this.viewport[0],coord_y:this.viewport[1]},bottom_right_tile:{coord_x:this.viewport[2],coord_y:this.viewport[3]}}},this.recalcViewport=function(){var e=this.pos[0],t=this.pos[1],i=this.coordByPixel(e,t),s=this.coordByPixel(e+this.size[0],t+this.size[1]);this.viewport=[i[0],i[1],s[0],s[1]]},this.inViewport=function(e,t){return e>=this.viewport[0]&&t>=this.viewport[1]&&e<=this.viewport[2]&&t<=this.viewport[3]},this.createMover=function(e){this.mover=new FreeMapMover(this),this.mover.setSpeed(e)},this.reload=function(e,t){if(!t){for(var i in this._loadedSectors){if(this._loadedSectors.hasOwnProperty(i))this._loadedSectors[i].despawn(!0)}this._loadedSectors={}}if(this._visibleSectors={},this.handler.onReload&&this.handler.onReload(),!1!==e){var s=this.pos[0],o=this.pos[1];this.pos=[0,0],this.setPosPixel(s,o)}},this._resizeElements=[],this._resizeTargetPosition=[],this.resize=function(e,t,i){if(void 0===e){var s=$(this.el.root).parent();e=s.width(),t=s.height()}var o=[[],[]],n=this.getCenter();if(2&i||(o[0].push(this.el.root),o[1].push(this.el.root)),this.handler.hasOwnProperty("getResizableElements")){var r=this.handler.getResizableElements();o[0]=o[0].concat(r[0]),o[1]=o[1].concat(r[1])}this.size=[e,t],this.handler.hasOwnProperty("onResize")&&this.handler.onResize(e,t),1&i?($(o[0]).animate({width:e+"px"},{duration:400,queue:!1}),$(o[1]).animate({height:t+"px"},{duration:400,queue:!1})):($(o[0]).width(e),$(o[1]).height(t)),2&i||(this.centerPos(n[0],n[1],!1),this.recalcViewport())},this._lastResizeSize=0,this.createResizer=function(e,t,i){i=i||1,$(this.el.root).resizable({grid:[i*this.scale[0],i*this.scale[1]],minWidth:e[0]*this.scale[0],maxWidth:t[0]*this.scale[0],minHeight:e[1]*this.scale[1],maxHeight:t[1]*this.scale[1],handles:"se",zIndex:13,start:$.proxy(function(e,t){this.handler.hasOwnProperty("onResizeBegin")&&this.handler.onResizeBegin(),TWMap.busy=!0,this._resizeTargetPosition=this.getCenter()},this),stop:$.proxy(function(){TWMap.busy=!1,this.centerPos(this._resizeTargetPosition[0],this._resizeTargetPosition[1],!1),this.handler.hasOwnProperty("onResizeEnd")&&this.handler.onResizeEnd()},this)}).resize($.proxy(function(){var e=$(this.el.root),t=1e5*e.width()+e.height();t!=this._lastResizeSize&&(this._lastResizeSize=t,this.resize(e.width(),e.height(),2),this.pos=[0,0],this.centerPos(this._resizeTargetPosition[0],this._resizeTargetPosition[1],!1),this.recalcViewport())},n))},this.effects={beaconVillage:function(e,t){if(TWMap.map.inViewport(e,t)){var i=$('<div class="center_beacon"></div>'),s=$('<div class="map_beacon_container"></div>'),o=TWMap.map.getViewport().top_left_tile,n=(e-o.coord_x+.5)*TWMap.tileSize[0],r=(t-o.coord_y+.5)*TWMap.tileSize[1];s.css({top:r+"px",left:n+"px"}).append(i),$("#special_effects_container").append(s),setTimeout(function(){Modernizr.cssanimations&&i.addClass("end"),setTimeout(function(){s.remove()},600)},100)}}},!0}function FreeMapMover(e){this.moveDirty=!1,this.allowDrag=!0,this.dragHandler=null,this.dragBeginHandler=null,this.dragEndHandler=null,this.dragBeginPosition=[],this.fixTouchEvent=function(e){return e.changedTouches&&(e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY,e.pageX=e.changedTouches[0].pageX,e.pageY=e.changedTouches[0].pageY),e},this.handleMouseDown=function(e){if(null!=this.touchIdentifier)return e.preventDefault(),!1;if((e=this.fixTouchEvent(e)).changedTouches&&(this.touchIdentifier=e.changedTouches[0].identifier),this.containerPos=[-(parseInt(this._map.el.container.style.left)-this._map.bias),-(parseInt(this._map.el.container.style.top)-this._map.bias)],this.mousePos=[e.clientX,e.clientY],this.moveDirty=!1,this.crappy_browser?(this._el.setCapture(),this._el.attachEvent("onmousemove",this._eventHandleMouseMove),this._el.attachEvent("onmouseup",this._eventHandleMouseUp),this._el.attachEvent("onlosecapture",this._eventHandleMouseUp)):(window.addEventListener("touchmove",this._eventHandleMouseMove,!0),window.addEventListener("mousemove",this._eventHandleMouseMove,!0),window.addEventListener("touchend",this._eventHandleMouseUp,!0),window.addEventListener("mouseup",this._eventHandleMouseUp,!0),e.preventDefault()),!1!==this.useDragTimer){var t=this;this.dragTimer=setInterval(function(){t.IEDragTimer()},this.useDragTimer),this.dragBeginPosition=[e.clientX,e.clientY],this.lastMousePositionForTimer=[e.clientX,e.clientY]}},this.handleMouseUp=function(e){if(e.changedTouches&&e.changedTouches[0].identifier!=this.touchIdentifier)return!1;if(this.touchIdentifier=null,this.crappy_browser?(this._el.releaseCapture(),this._el.detachEvent("onmousemove",this._eventHandleMouseMove),this._el.detachEvent("onmouseup",this._eventHandleMouseUp),this._el.detachEvent("onlosecapture",this._eventHandleMouseUp)):(window.removeEventListener("touchmove",this._eventHandleMouseMove,!0),window.removeEventListener("mousemove",this._eventHandleMouseMove,!0),window.removeEventListener("touchend",this._eventHandleMouseMove,!0),window.removeEventListener("mouseup",this._eventHandleMouseUp,!0)),!1!==this.useDragTimer&&(clearInterval(this.dragTimer),this.dragTimer=void 0),this.moveDirty&&(this.allowDrag&&this._map.handler.hasOwnProperty("onDragEnd")?this._map.handler.onDragEnd():this.dragEndHandler&&this.dragEndHandler()),!this.moveDirty&&e.changedTouches&&this._map.handler.onClick){e=this.fixTouchEvent(e);var t={};t.pageX=e.changedTouches[0].pageX,t.pageY=e.changedTouches[0].pageY;var i=this._map.coordByEvent(t);e.stopPropagation(),this._map.handler.onClick(i[0],i[1])}return setTimeout(jQuery.proxy(function(){this.moveDirty=!1},this),50),e.returnValue=!1,e.preventDefault&&e.preventDefault(),!1},this.IEDragTimer=function(){var e={clientX:this.lastMousePositionForTimer[0],clientY:this.lastMousePositionForTimer[1]};0==e.clientX&&0==e.clientY||this.handleMouseMove(e,!0)},navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)?this.useDragTimer=100:$.browser.webkit|$.browser.safari?this.useDragTimer=40:$.browser.mozilla?this.useDragTimer=40:$.browser.msie?this.useDragTimer=60:$.browser.opera?this.useDragTimer=30:this.useDragTimer=60,this.handleMouseMove=function(e,t){if(e.changedTouches&&e.changedTouches[0].identifier!=this.touchIdentifier)return!1;if(e=this.fixTouchEvent(e),!1!==this.useDragTimer&&void 0===t)return this.lastMousePositionForTimer=[e.clientX,e.clientY],!1;var i=[e.clientX-this.mousePos[0],e.clientY-this.mousePos[1]];this.mousePos=[e.clientX,e.clientY];var s=[this.containerPos[0]-i[0]*this._speed,this.containerPos[1]-i[1]*this._speed];if(this._map.handler.scrollBound){var o=this._map.handler.scrollBound,n=this._map.coordByPixel(s[0],s[1],!0);n[0]<o.x_min&&i[0]>0&&(i[0]=0),n[1]<o.y_min&&i[1]>0&&(i[1]=0);var r=this._map.coordByPixel(s[0]+this._map.size[0],s[1]+this._map.size[1]);r[0]>o.x_max&&i[0]<0&&(i[0]=0),r[1]>o.y_max&&i[1]<0&&(i[1]=0)}return 0==i[0]&&0==i[1]||0!=this.moveDirty||(this.allowDrag&&this._map.handler.onDragBegin?this._map.handler.onDragBegin():this.dragBeginHandler&&this.dragBeginHandler(),this.moveDirty=!0),this.allowDrag?(this.containerPos[0]-=i[0]*this._speed,this.containerPos[1]-=i[1]*this._speed,this._map.setPosPixel(this.containerPos[0],this.containerPos[1]),!1):(this.moveDirty&&this.dragHandler&&this.dragHandler(this.dragBeginPosition,this.mousePos,i),!1)},this.setSpeed=function(e){this._speed=e},this.preventDrag=function(e,t,i){!0===e||!1===e?(this.allowDrag=!e,this.dragHandler=null,this.dragEndHandler=null,$(this._el).css("cursor","move")):(this.allowDrag=!1,this.dragHandler=e,this.dragBeginHandler=t,this.dragEndHandler=i,$(this._el).css("cursor","default"))};var t=document.createElement("div");t.setAttribute("id",e.el.root.id+"_mover"),$(t).addClass("needsclick"),$(t).attr("style",'position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; z-index: 12; background-image: url("/graphic/map/empty.png"); cursor: move; -moz-user-select: none;'),this.crappy_browser=t.setCapture&&t.detachEvent;var i=this;this._eventHandleMouseDown=function(e){return i.handleMouseDown(e)},this._eventHandleMouseMove=function(e){return i.handleMouseMove(e)},this._eventHandleMouseUp=function(e){return i.handleMouseUp(e)},this._speed=1,this.crappy_browser?t.attachEvent("onmousedown",this._eventHandleMouseDown):(t.addEventListener("touchstart",this._eventHandleMouseDown,!0),t.addEventListener("mousedown",this._eventHandleMouseDown,!0)),this._map=e,this._el=t,e.el.mover=t,e.el.root.appendChild(t)}function compareCoord(e,t){return e[0]==t[0]&&e[1]==t[1]}

;/**** game/twmap.js_ ****/
var TWMap={map:null,minimap:null,minimap_only:!1,minimap_highlight:0,mobile:!1,fullscreen:!1,cachePopupContents:!1,minimap_cache_stamp:0,mapSubSectorSize:5,urls:{},colors:{},classic_gfx:!1,old_map_gfx:!1,graphics:null,image_base:null,images:[],ghost_village_tile:51,selected_village:null,scriptMode:!1,attackPlannerMode:!1,attackPlannerGeneration:0,villages:{},villageKey:{},players:{},allies:{},ghost:!1,playerColors:{},allyColors:{},villageColors:{},villageIcons:{},commandIcons:{},troop_templates:{},current_units:{},command_hash:[],troop_template_id:0,troop_template_command:"",allyRelations:{},reservations:{},friends:{},targets:[],pos:[],size:[0,0],isAutoSize:!1,minimap_offset:[0,0],minimap_size:[0,0],currentCon:null,currentVillage:null,scrollBound:{x_min:0,x_max:999,y_min:0,y_max:999},keys:{},ignore_villages:[],non_attackable_players:null,non_attackable_villages:null,goFullscreen:function(){if(!TWMap.premium)return!1;var e=document.getElementById("map_wrap"),a="fullscreenchange mozfullscreenchange webkitfullscreenchange";if(e.requestFullScreen)e.requestFullScreen();else if(e.mozRequestFullScreen)e.mozRequestFullScreen();else{if(!e.webkitRequestFullScreen)return!1;e.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}$(document).bind(a,function(){var e=TWMap.size;TWMap.fullscreen=!0,TWMap.resize(0,!1),$("#map_popup").detach().appendTo("#map_wrap"),$("#minimap").detach().appendTo("#map_wrap"),$("#fullscreen").hide(),$(document).unbind(a).bind(a,function(){$("#map_popup").detach().appendTo($("body")),$("#minimap").detach().appendTo($("#minimap_cont")),$("#fullscreen").show(),TWMap.resize(e,!0),TWMap.fullscreen=!1,$(document).unbind(a)})})},showEmbeddedMap:function(e,a,t,i,o){TWMap.minimap_only=!0,TWMap.tileSize=[53,28],TWMap.topoKey=e,TWMap.minimap_highlight=o,TWMap.minimap_cache_stamp=a||0,TWMap.init(),TWMap.focus(t,i,!1)},storeSectorInformation:function(e){var a;for(a=0;a<e.length;a++){var t=e[a],i=t.data,o=i.x,n=i.y;TWMap.storeVillage.set(o,n,t.data),t.tiles&&TWMap.storeTiles.set(o,n,t.tiles),t.pmap&&TWMap.storePolitical.set(o,n,t.pmap),t=null,i=null}},mapHandler:{_waitingSectors:{},onReceiveSectorInformation:function(e,a){a||TWMap.storeSectorInformation(e);for(var t=0;t<e.length;t++){var i=e[t],o=i.data,n=o.x,s=o.y,l=this._waitingSectors[n+"_"+s];if(l){i.tiles&&(l.tiles=i.tiles),i.pmap&&(l.pmap=i.pmap),l.x=n,l.y=s,l.data=o;var p=[];for(var r in o.villages)if(o.villages.hasOwnProperty(r))for(var c in r=parseInt(r),o.villages[r]){if(o.villages[r].hasOwnProperty(c))if(c=parseInt(c),0===(d=o.villages[r][c])[2]&&d[8]?d[2]=_("0bf7975983a90288f809600303ae52cc"):0===d[2]&&(d[2]=_("acd537450651fef7501d8f80cb075fa3")),-1==$.inArray(d[0],TWMap.ignore_villages)){var m=1e3*(n+r)+s+c;TWMap.villageKey[d[0]]=m,TWMap.villages[m]={id:d[0],img:d[1],name:d[2],points:d[3],owner:d[4],mood:d[5],bonus:d[6],event_special:d[7],xy:m,bonus_id:d[8],owner_text:d[9],type:d[10],ally_id:d[11]},p.push(d[0])}}for(var u in o.players)if(o.players.hasOwnProperty(u)){var d=o.players[u];TWMap.players[u]={name:d[0],points:d[1],ally:d[2],newbie:d[3],sleep:d[4],image_id:d[5],village_count_text:d[6]}}for(var h in o.allies)if(o.allies.hasOwnProperty(h)){d=o.allies[h];TWMap.allies[h]={name:d[0],points:d[1],tag:d[2],image_id:d[3]}}for(var g=0;g<l.queue.length;g++)l.queue[g].loaded=!0,this.spawnSector(l,l.queue[g]);delete this._waitingSectors[n+"_"+s]}}},getSectorIdByTile:function(e,a){return e-e%20+"_"+(a-a%20)},getSubsectorIdByTile:function(e,a){return Math.floor(e/5)+"_"+Math.floor(a/5)},loadSectors:function(e){for(var a=[],t=0;t<e.length;t++){var i=e[t],o=i.x-i.x%20,n=i.y-i.y%20,s=o+"_"+n;(p=this._waitingSectors[s])?p.queue.push(i):(p={id:s,x:o,y:n,tiles:null,pmap:null,data:null,queue:[i]},this._waitingSectors[s]=p,a.push(p))}if(!(a.length<1)){this._sector_request_queue=[];for(t=0;t<a.length;t++){(p=a[t]).tiles=TWMap.storeTiles.get(p.x,p.y),p.data=TWMap.storeVillage.get(p.x,p.y),TWMap.politicalMap.displayed?p.pmap=TWMap.storePolitical.get(p.x,p.y):p.pmap=[[],[]],null!==p.data&&null!==p.tiles&&null!==p.pmap?this.onReceiveSectorInformation([p],!0):this._sector_request_queue.push(p)}if(this._sector_request_queue.length>0){var l="/map.php?v=2&locale="+window.game_data.locale+"&e="+(new Date).getTime();for(t=0;t<this._sector_request_queue.length;t++){var p,r=0;null===(p=this._sector_request_queue[t]).tiles&&(r+=1),null===p.pmap&&(r+=2),l+="&"+p.id+"="+r}$.ajax({type:"GET",url:l,dataType:"json",success:function(e){return TWMap.mapHandler.onReceiveSectorInformation(e,!1)}}),this._sector_request_queue=[]}}},onMovePixel:function(e,a){this.busy||TWMap.positionMinimap(),TWMap.minimap_only||(e-=TWMap.map.bias,a-=TWMap.map.bias,TWMap.map_el_coordy.style.top=-a+"px",TWMap.map_el_coordx.style.left=-e+"px",TWMap.context.hide(),TWMap.home.updateDisplay())},onMove:function(e,a){if(TWMap.pos=[e,a],!TWMap.minimap_only){for(var t=Math.min(1e3,a+20),i=Math.max(0,a-20);i<t;i++)TWMap._coord_el_y_active[i]||(TWMap._coord_el_y_active[i]=!0,TWMap.map_el_coordy.appendChild(TWMap._coord_el_y[i]));for(var o=Math.min(1e3,e+20),n=Math.max(0,e-20);n<o;n++)TWMap._coord_el_x_active[n]||(TWMap._coord_el_x_active[n]=!0,TWMap.map_el_coordx.appendChild(TWMap._coord_el_x[n]));TWMap.busy||(TWMap.busy=!0,TWMap.updateContinent(),TWMap.busy=!1)}},onDragBegin:function(){TWMap.popup.unregister()},onDragEnd:function(){TWMap.popup.register()},onClick:function(e,a,t){var i=TWMap.villages[1e3*e+a];if(i)if(TWMap.troop_template_command){var o=Object.create(TWMap.current_units);if("all"!=TWMap.troop_template_id){var n=TWMap.troop_templates[TWMap.troop_template_id];for(var s in o)o[s]=n[s];n.use_all.forEach(function(e){o[e]=TWMap.current_units[e]})}var l={template_id:TWMap.troop_template_id,source_village:TWMap.currentVillage,x:e,y:a,input:""};l=$.extend(l,o),"attack"==TWMap.troop_template_command?l.attack=1:"support"==TWMap.troop_template_command&&(l.support=1),l[TWMap.command_hash[0]]=TWMap.command_hash[1];var p=function(e){e.preventDefault();var a=$("#command-data-form").serializeArray();TribalWars.post("place",{ajaxaction:"popup_command"},a,function(e){Dialog.close(),UI.SuccessMessage(e.message);for(var a=0;a<CommandPopup.command_sent_hooks.length;a++)CommandPopup.command_sent_hooks[a](e);!function(){for(var e in o)TWMap.current_units[e]-=o[e]}()})};TribalWars.post("place",{village:TWMap.currentVillage,ajax:"confirm"},l,function(e){Dialog.show("confirm_attack",e.dialog),$("#command-data-form").on("submit",p),$("#troop_confirm_back").on("click",CommandPopup.goBack)})}else{if(TWMap.attackPlannerMode>1)return AttackPlanner.onVillageClicked(i.id,e,a),!1;if(!TWMap.context.enabled)return(!t||$.browser.msie&&~~$.browser.version<8)&&(window.location.href=TWMap.urls.villageInfo.replace(/__village__/,i.id)),!0;premium&&TWMap.church.possible_displayed&&(MapCanvas.selected_x=e,MapCanvas.selected_y=a,TWMap.selected_village=i.id,TWMap.reload(!1)),TWMap.context.spawn(i,e,a)}else TWMap.context.hide(),premium&&TWMap.church.possible_displayed&&(MapCanvas.selected_x=null,MapCanvas.selected_y=null,TWMap.selected_village=null,TWMap.reload(!1));return!1},onReload:function(){this._waitingSectors={},TWMap.allies={},TWMap.villages={}},_createBorder:function(e){var a=document.createElement("div");return a.className=e?"map_con_border":"map_border",TWMap.night&&!TWMap.classic_gfx&&(a.className+="_night"),a.style.zIndex="3",a.style.position="absolute",a},spawnSector:function(e,a){alert("Missing spawnSector function!")}},minimapHandler:{loadSector:function(e){var a=document.createElement("img");a.style.position="absolute",a.style.zIndex="1";game_data&&game_data.village&&game_data.village.id;var t=TWMap.politicalMap.displayed&&!TWMap.attackPlannerMode?TWMap.politicalMap.filter:0,i=TWMap.church.displayed?1:0,o=TWMap.church.possible_displayed?1:0,n=TWMap.church.levels,s=($.param({church_levels:n}),1===TWMap.attackPlannerMode?1+TWMap.attackPlannerGeneration:0),l={page:"topo_image",player_id:game_data.player.id,x:e.x,y:e.y,church:i,possible_church:o,political:t,attack_planner:s,watchtower:TribalWars._settings.map_show_watchtower?1:0,key:TWMap.topoKey,cur:game_data.village.id,focus:TWMap.minimap_highlight,local_cache:TWMap.minimap_cache_stamp,church_levels:n};game_data&&game_data.village&&(l.village_id=game_data.village.id),null!=TWMap.selected_village&&(l.selected=TWMap.selected_village),a.setAttribute("src","/page.php?"+$.param(l)),e.appendElement(a,0,0)},onMovePixel:function(e,a){if(!TWMap.busy){if(TWMap.busy=!0,TWMap.map){var t=e/TWMap.minimap.scale[0]+TWMap.minimap_offset[0],i=a/TWMap.minimap.scale[1]+TWMap.minimap_offset[1];TWMap.map.setPos(t,i),TWMap.home.updateDisplay()}TWMap.updateContinent(),TWMap.busy=!1}},onClick:function(e,a,t){TWMap.focus(e,a)}},positionMinimap:function(){if(this.minimap){var e=this.busy;this.busy=!0,this.minimap.setPos(this.map.pos[0]/this.map.scale[0]-this.minimap_offset[0],this.map.pos[1]/this.map.scale[1]-this.minimap_offset[1]),this.busy=e}},updateCommandIcon:function(e,a,t){var i=this.mapHandler.getSubsectorIdByTile(e.x,e.y);if(void 0!==this.map._loadedSectors[i]){void 0===this.commandIcons[e.id]&&(this.commandIcons[e.id]=[]);var o=this.commandIcons[e.id];o=$.grep(o,function(e){return e.img!==a}),t&&o.push({img:a}),this.commandIcons[e.id]=o,$(this.map._loadedSectors[i]._element_root).find("[id*=map_cmdicons_"+e.id+"]").remove();for(var n=this.generateCommandIcons(e.id),s=e.x%5,l=e.y%5,p=0;p<n.length;p++)this.map._loadedSectors[i].appendElement(n[p],s,l)}},generateCommandIcons:function(e){var a=[];if(TWMap.commandIcons[e])for(var t=TWMap.commandIcons[e],i=(t.length,2*(Math.max(2,t.length)-2)),o=14-i,n=0;n<t.length;n++){var s=document.createElement("img");s.style.position="absolute",s.style.right="0px",s.style.zIndex="4",s.style.width=o+"px",s.style.height=o+"px",s.style.marginTop="0px",s.style.marginLeft=34+2*i-n*(o+5-i)+"px",s.id="map_cmdicons_"+e+"_"+n,s.src=TWMap.image_base+"/map/"+t[n].img+".png",a.push(s)}return a},createVillageIcons:function(e){if(TWMap.minimap_only)return[];var a=[],t=0;if(TWMap.villageIcons[e.id]){var i=TWMap.villageIcons[e.id];for(var o in i)if(i.hasOwnProperty(o)){var n,s=i[o];t++,(n=document.createElement("img")).style.position="absolute",n.style.top="0px",n.style.left="0px",n.style.width="18px",n.style.height="18px",n.style.zIndex="4",n.style.marginTop="18px",n.style.marginLeft=20*t-20+"px",n.id="map_icons_"+e.id,n.style.backgroundColor=s.c,n.src=s.img?s.img:TWMap.image_base+"/blank-16x22.png",a.push(n)}}TWMap.reservations.hasOwnProperty(e.id)&&(t++,(n=document.createElement("img")).style.position="absolute",n.style.top="0px",n.style.left="0px",n.style.width="18px",n.style.height="18px",n.style.zIndex="4",n.style.marginTop="18px",n.style.marginLeft=20*t-20+"px",n.src="/graphic/map/reserved_"+TWMap.reservations[e.id]+".png",a.push(n));var l=this.generateCommandIcons(e.id);if($(l).each(function(){a.push(this)}),TWMap.attackPlannerMode){var p=AttackPlanner.getMapInfo();if(p[e.id]){var r=0;$.each(p[e.id].type,function(e,t){if(t){var i=document.createElement("img");switch(i.style.position="absolute",i.style.zIndex="10",r){case 0:default:i.style.marginTop="0px",i.style.marginLeft="0px";break;case 1:i.style.marginTop="20px",i.style.marginLeft="0px";break;case 2:i.style.marginTop="0px",i.style.marginLeft="35px";break;case 3:i.style.marginTop="20px",i.style.marginLeft="35px"}i.src=TWMap.image_base+"/icons/attack_planner_"+e+".png",a.push(i),r++}})}}return a},createVillageDot:function(e){var a=document.createElement("canvas");if(a.getContext){a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.width=18,a.height=18,a.style.zIndex="4",a.style.marginTop="0px",a.style.marginLeft="0px";var t=a.getContext("2d");return t.fillStyle="rgb("+e[0]+","+e[1]+","+e[2]+")",t.strokeStyle="#000000",t.beginPath(),t.arc(5,5,3.3,0,2*Math.PI,!1),t.fill(),t.stroke(),a}var i=document.createElement("img");return i.style.position="absolute",i.style.left="0px",i.style.top="0px",i.style.width="6px",i.style.height="6px",i.style.zIndex="4",i.style.marginTop="3px",i.style.marginLeft="0px",i.style.border="0px",i.style.backgroundColor="rgb("+e[0]+","+e[1]+","+e[2]+")",i},updateContinent:function(){var e=TWMap.con.continentByXY(TWMap.pos[0],TWMap.pos[1]);e!=TWMap.currentCon&&($("#continent_id").html(e),TWMap.currentCon=e)},getMinimapScrollBound:function(){var e=$.extend({},this.scrollBound);return e.x_min-=this.minimap_offset[0],e.y_min-=this.minimap_offset[1],e.x_max+=this.minimap_size[0]-this.minimap_offset[0]-this.size[0],e.y_max+=this.minimap_size[1]-this.minimap_offset[1]-this.size[1],e},initMap:function(){alert("Missing initMap function!")},focus:function(e,a){alert("Missing focus function!")},init:function(){this.politicalMap.optionToggle=new MapToggleBox({id:"pmap_options"}),this.church.optionToggle=new MapToggleBox({id:"church_options"}),this.storeVillage=new TWMapStore(3,30),this.storePolitical=new TWMapStore(3,600),this.storeTiles=new TWMapStore(6,86400),this.sectorPrefech&&(this.storeSectorInformation(this.sectorPrefech),this.sectorPrefech=null),this.initMap(),TWMap.premium&&(document.body.requestFullScreen||document.body.mozRequestFullScreen||document.body.webkitRequestFullScreen)&&$("#fullscreen").show(),TWMap.updateContinent();var e=window.location.hash.match(/^#([0-9]+);([0-9]+)$/);TWMap.map&&null!==e&&setTimeout(function(){TWMap.map.centerPos(e[1],e[2])},100),setInterval(function(){var e="#"+TWMap.pos[0]+";"+TWMap.pos[1];e!=window.location.hash&&window.location.replace(e)},200),TWMap.map&&null!=game_data.village.id?(TWMap.home.init(),TWMap.home_aura.init()):TWMap.home.active=!1,Connection.registerObserver("map",this.synchronizer),Connection.enqueueHandler("units_arrived",function(e){if(e.village_id==TWMap.currentVillage)for(var a in e.unit_count){var t=e.unit_count[a];TWMap.current_units[a]=parseInt(TWMap.current_units[a])+t}})},focusSubmit:function(){var e=~~$("#mapx").val(),a=~~$("#mapy").val();return this.focusUserSpecified(e,a),!1},focusUserSpecified:function(e,a){return this.focus(e,a),TWMap.map&&TWMap.map.effects.beaconVillage(e,a),!1},scrollBlock:function(e,a){alert("scrollBlock function missing")},updateSizeSelect:function(e,a,t){var i;if(e[0]==e[1]&&(i=$(a).find('option[value="'+e[0]+'"]'))&&i.length>0)i.attr("selected","selected"),$(t).hide();else{var o=e[0]+"x"+e[1];$(t).show().val(o).text(o).attr("selected","selected")}},notifyMapSize:function(e,a){var t=this.size.join("x"),i=this.minimap_size.join("x"),o=t+"-"+i;TWMap._lastNotifiedMapsize!=o&&(TWMap._lastNotifiedMapsize=o,this.updateSizeSelect(TWMap.size,"#map_chooser_select","#current-map-size"),this.updateSizeSelect(TWMap.minimap_size,"#minimap_chooser_select","#current-minimap-size"),mobile||TWMap.fullscreen?e?$.cookie("mobile_mapsize",0,{expires:7}):$.cookie("mobile_mapsize",t,{expires:7}):$.ajax({url:this.urls.sizeSave,data:"map_size="+t+"&minimap_size="+i,type:"GET",success:function(){a&&window.location.reload()}}))},scaleMinimap:function(){var e,a=[~~(this.minimap.size[0]/this.minimap.scale[0]),~~(this.minimap.size[1]/this.minimap.scale[1])];e=this.map?[~~(this.map.size[0]/this.map.scale[0]),~~(this.map.size[1]/this.map.scale[1])]:[0,0];var t=[~~((a[0]-e[0])/2),~~((a[1]-e[1])/2)];this.minimap_offset=t,this.minimap_size=a;var i=document.getElementById("minimap_viewport"),o=e[0]*this.minimap.scale[0],n=e[1]*this.minimap.scale[1];i.style.width=o+"px",i.style.height=n+"px";var s=t[0]*this.minimap.scale[0],l=t[1]*this.minimap.scale[1];i.style.left=s+"px",i.style.top=l+"px"},tileDimensions:function(e){return[Math.ceil(e.width()/this.tileSize[0]),Math.ceil(e.height()/this.tileSize[1])]},notifySavedChanges:function(){UI.SuccessMessage(_("cc10973ebae83eeb2a4085216a71953a"))},CoordByXY:function(e){return[~~(e/1e3),e%1e3]},popup:{enabled:!0,optionToggle:null,attackDots:["","/dots/green.png","/dots/yellow.png","/dots/red.png","/dots/blue.png","/dots/red_yellow.png","/dots/red_blue.png"],attackMaxLoot:["/max_loot/0.png","/max_loot/1.png"],_px:0,_py:0,init:function(){this.enabled=!0,this.optionToggle=new MapToggleBox({id:"popup_options"}),$("#form_map_popup").find("input").change(function(){TribalWars.post("map",{ajaxaction:"save_map_popup"},$("#form_map_popup").serialize(),function(){TWMap.notifySavedChanges()}),TWMap.popup.enabled&&TWMap.popup.invalidateCache()}),this._cache={},this.el=$("#map_popup"),$(this.el).on("mousemove",function(e){return TWMap.popup.handleMouseMove(e)}),this.register();var e=this;$(TWMap.map.el.root).on("mouseout",function(){e.hide()}),this._loadingText=$("#info_extra_info").find("td").html()},invalidateCache:function(){this._cache={}},invalidateVillage:function(e){delete this._cache[e],this._currentVillage==e&&this.loadVillage(e)},receivedPopupInformation:function(e){if(e[0])for(var a=0;void 0!==e[a];a++)this.receivedPopupInformationForSingleVillage(e[a]);else this.receivedPopupInformationForSingleVillage(e),this.calcPos()},receivedPopupInformationForSingleVillage:function(e){var a=TWMap.villages[e.xy];if(a){this._cache[e.id]=e;var t=TWMap.CoordByXY(e.xy);this.displayForVillage(a,t[0],t[1]),TWMap.cachePopupContents||delete this._cache[e.id]}},popupOptionsSet:function(){var e=!1;return $("#popup_options").find("input[type=checkbox]").each(function(){1==$(this).is(":checked")&&(e=!0)}),e},_isAwayFromContext:function(e,a){if(-1==TWMap.context._curFocus)return!0;var t=TWMap.CoordByXY(TWMap.context._curFocus),i=[Math.abs(e-t[0]),Math.abs(a-t[1])];return i[0]>=2||i[1]>=2},loadVillage:function(e){TribalWars.get(TWMap.urls.villagePopup.replace(/__village__/,e),{},function(e){return TWMap.popup.receivedPopupInformation(e)}),this._cache[e]="notanobject"},handleMouseMove:function(e){if(this!=TWMap.popup)return!1;var a=TWMap.map.coordByEvent(e),t=a[0],i=a[1],o=1e3*t+i,n=TWMap.villages[o];if(n&&TWMap.map.inViewport(t,i)&&this._isAwayFromContext(t,i)){if(TWMap.context.hide(),"ghost"==n.special?TWMap.map.el.root.href=TWMap.urls.ctx.mp_invite:TWMap.map.el.root.href=TWMap.urls.ctx.mp_info.replace(/__village__/,n.id),this._currentVillage=n.id,TWMap.map.el.mover&&(TWMap.troop_template_command?TWMap.map.el.mover.style.cursor=s("url(%1), pointer",s("/graphic/btn/%1.png",TWMap.troop_template_command)):TWMap.map.el.mover.style.cursor="pointer"),!this.enabled)return!1;this._px=e.pageX,this._py=e.pageY,this._x!=t||this._y!=i?(this.displayForVillage(n,t,i),this.el.fadeIn(50),this._is_visible=!0):this.calcPos()}else{if(TWMap.map.el.mover){var l=TWMap.attackPlannerMode?"default":"move";TWMap.troop_template_command?TWMap.map.el.mover.style.cursor=s("url(%1), %2",s("/graphic/btn/%1.png",TWMap.troop_template_command),l):TWMap.map.el.mover.style.cursor=l}this._is_visible&&(TWMap.map.el.root.href="#",this.hide())}this._x=t,this._y=i},displayForVillage:function(e,a,t){if(this._currentVillage==e.id){var i=TWMap.players[e.owner],o={bonus:null,type:e.type,name:e.name,x:a,y:t,continent:TWMap.con.continentByXY(a,t),points:e.points,owner:null,owner_image:null,newbie:null,ally:null,ally_image:null,extra:null,special:null,units:[],units_display:{}};if(e.hasOwnProperty("special")&&(o.special=e.special),e.bonus_id&&(o.bonus={text:TWMap.bonus_data[e.bonus_id].text,img:TWMap.bonus_data[e.bonus_id].image}),i){o.owner=i,i.newbie&&e.owner!=game_data.player.id&&(o.owner.newbie_time=i.newbie),i.image_id&&i.image_id>0&&(o.owner_image=Format.userImageThumbURL(i.image_id));var n=TWMap.allies[i.ally];n&&(o.ally=n,n.image_id&&n.image_id>0&&(o.ally_image=Format.userImageThumbURL(n.image_id)))}if(this.extraInfo&&TWMap.popup.popupOptionsSet()){var s=this._cache[e.id];if(void 0===s&&e.id)this.loadVillage(e.id),o.extra=!1;else if("object"==typeof s){var l={total:$("#map_popup_units").is(":checked"),home:$("#map_popup_units_home").is(":checked"),time:$("#map_popup_units_times").is(":checked")};if(o.units_display.count=!1,o.units_display.time=l.time&&s.id!=TWMap.currentVillage,l.total||l.home||l.time)for(var p in s.units)if(s.units.hasOwnProperty(p)){var r=parseInt(s.units[p].count.home)+parseInt(s.units[p].count.foreign),c=l.total&&0!=r;if(c||l.time&&s.units[p].time){var m="";c&&(m=r,l.home&&0!=s.units[p].count.home&&(m+='<br/><span class="unit_count_home">('+s.units[p].count.home+")</span>"),o.units_display.count=l.total),o.units.push({name:p,image:s.units[p].image,time:s.units[p].time,count:m})}}o.extra=s}}$("#map_popup").html(jstpl("tpl_popup",o)),this.calcPos(),this.initTimers()}},calcPos:function(){var e=[this.el.width(),this.el.height()],a=[$(window).scrollLeft()+3,$(window).scrollTop()+3,$(window).scrollLeft()+$(window).width()-3,$(window).scrollTop()+$(window).height()-3];a[1]+=$("#topContainer").height(),a[3]-=$("#footer").height(),this._py+15+e[1]<a[3]?y=this._py+15:this._py-15-a[1]>=e[1]?y=this._py-e[1]-15:y=this._py+15,x=this._px+15,x-=Math.max(0,x+e[0]-a[2]),x=Math.max(x,$(window).scrollLeft()),this.el.css("left",x+"px"),this.el.css("top",y+"px")},initTimers:function(){var e=this;$("span.map_info_timer").on("timer_end",function(){e.loadVillage(e._currentVillage)}),Timing.tickHandlers.timers.initTimers("map_info_timer",null)},invalidPos:function(){this.el.css("left","-2000px").css("top","-2000px")},register:function(){$(TWMap.map.el.root).on("mousemove",function(e){return TWMap.popup.handleMouseMove(e)})},unregister:function(){$(TWMap.map.el.root).unbind("mousemove"),TWMap.map.el.mover&&(TWMap.map.el.mover.style.cursor="move"),this.hide()},hide:function(){this._is_visible&&(this._currentVillage=0,this.el.fadeOut(50),this._x=0,this._y=0,this._is_visible=!1)}},reload:function(e){var a=TWMap.map.pos;e=e||!1,TWMap.map.reload(e),TWMap.minimap.reload(e),TWMap.map.pos=[0,0],TWMap.minimap.pos=[0,0],TWMap.map.setPosPixel(a[0],a[1])},politicalMap:{displayed:!1,filter:1,optionToggle:null,toggle:function(e){var a=$("#politicalmap").is(":checked"),t=~~$("#pmap_options").find('input[name="pmap_filter"]:checked').val();$("#pmap_show_topo").is(":checked")&&(t+=8),$("#pmap_show_map").is(":checked")&&(t+=16),$.ajax({url:TWMap.urls.changeShowPolitical,data:{topo_show_politicalmap:a,topo_politicalmap_filter:t},type:"GET",success:function(){TWMap.notifySavedChanges()}}),e&&(a?this.optionToggle.show():this.optionToggle.hide()),(a!=this.displayed||a&&t!=this.filter)&&(this.displayed=a,this.filter=t,TWMap.reload())}},church:{displayed:!1,possible_displayed:!1,optionToggle:null,levels:[],enabled:1!=$.browser.msie,toggle:function(e,a){var t=$("#belief_radius").is(":checked"),i=$("#belief_radius_2").is(":checked"),o=[];$("input[name='church_level[]']:checked").each(function(){o.push(parseInt($(this).val()))}),$.ajax({url:TWMap.urls.changeShowBelief,data:{topo_show_belief:t,topo_belief_levels:o,topo_church_possible:i},type:"GET",success:function(){TWMap.notifySavedChanges(),TWMap.church.levels=o}}),e&&(i?this.optionToggle.show():this.optionToggle.hide()),(t!=this.displayed||i!=this.possible_displayed||i&&o!=this.levels)&&(this.displayed=t,this.possible_displayed=i,this.levels=o,TWMap.reload())}},non_attackable_hide:{toggle:function(){var e=$("#non_attackable_hide").is(":checked");TribalWars.setSetting("map_casual_hide",e,function(){TWMap.reload(),TWMap.notifySavedChanges()})}},watchtower:{toggle:function(){var e=$("#show_watchtower").is(":checked");TribalWars.setSetting("map_show_watchtower",e,function(){TWMap.reload()})}},inline_send:{enabled:!1},con:{SEC_COUNT:1,SUB_COUNT:1,CON_COUNT:1,continentByXY:function(e,a){return Math.floor(e/(TWMap.con.SEC_COUNT*TWMap.con.SUB_COUNT))+Math.floor(a/(TWMap.con.SEC_COUNT*TWMap.con.SUB_COUNT))*TWMap.con.CON_COUNT}},context:{_curFocus:-1,_visible:!0,_circlePos:[[-12,-12],[-12,-49],[20,-30],[20,6],[-11,25],[-44,6],[-44,-30],[20,-30],[20,6]],_otherOrder:[],_ownOrder:[],_showPremium:!1,FATooltip:{init:function(e,a,t,i){var o=$("#"+e),n=o.data("minspeed"),s=game_data.village.coord.split("|"),l=this.distance(s[0],s[1],t,i),p=this.unitsDistance(l,a,o.data("template")),r=this.calculateDuration(p,n);o.data("duration",r),o.data("has-no-units")?o.css("opacity",.5):o.css("opacity",1),this.bind(o)},bind:function(e){e.bind("mouseover",function(a){void 0===e.data("tooltip")&&(UI.ToolTip(e,{bodyHandler:TWMap.context.FATooltip.create}),e.triggerHandler("mouseover"))})},create:function(){var e=$(this),a=e.data("tooltip-tpl"),t=e.data("duration");return e.data("has-no-units")?a:a+TWMap.context.FATooltip.formatDuration(t)},distance:function(e,a,t,i){var o=e-t,n=a-i;return Math.sqrt(o*o+n*n)},unitsDistance:function(e,a,t){var i=e;return TWMap.GreatSiege.isSiegeVillage(game_data.village.id)&&(i=TWMap.GreatSiege.getTravelDistanceFromSiegeVillage(t,e)),TWMap.GreatSiege.isSiegeVillage(a)&&(i=TWMap.GreatSiege.getTravelDistanceToSiegeVillage(t)),i},calculateDuration:function(e,a){return Math.round(e/a)},formatDuration:function(e){var a=Math.floor(e/3600),t=Math.floor(e/60)%60;t<10&&(t="0"+t);var i=e%60;return i<10&&(i="0"+i),"<span style='line-height: 20px'>"+(a+":"+t+":"+i)+"</span><br />"}},spawn:function(e,a,t){var i=1e3*a+t;if($("#map-ctx-buttons").attr("class","village-type-"+e.type),i==this._curFocus)return"ghost"==e.special?window.location.href=TWMap.urls.ctx.mp_invite:window.location.href=TWMap.urls.villageInfo.replace(/__village__/,e.id),!0;this.hide(),TWMap.popup.hide();var o=TWMap.map.pixelByCoord(a,t),n=TWMap.map.pos,s=[o[0]-n[0],o[1]-n[1]];s[0]+=TWMap.tileSize[0]/2,s[1]+=TWMap.tileSize[1]/2;var l=this,p=[],r=[];e.hasOwnProperty("special")?"ghost"==e.special&&(r=[null,null,"mp_invite","mp_invite_hide"]):r=e.owner==game_data.player.id?this._ownOrder:this._otherOrder;var c=this._circlePos;$(r).each(function(i,o){if(("0"!=e.owner||"mp_profile"!=o&&"mp_msg"!=o)&&(l._showPremium||"mp_recruit"!=o&&"mp_fav"!=o&&"mp_lock"!=o)&&("mp_farm_a"!=o&&"mp_farm_b"!=o||!(!game_data.features.FarmAssistent.possible||VillageContext.send_attack_disabled||e.owner>0||e.event_special>0||"standard"!==e.type))&&(game_data.village.id!=e.id||"mp_res"!=o&&"mp_att"!=o)&&(0!=game_data.player.ally&&"standard"===e.type||"mp_lock"!=o)&&(e.points||"mp_fav"!=o&&"mp_lock"!=o)&&(VillageContext.claim_enabled||"mp_lock"!==o)&&("mp_res"!=o||5!=parseInt(e.event_special))&&("mp_msg"!==o||VillageContext.igm_enabled)&&("mp_att"!=o||VillageContext.send_troops_enabled)){"mp_lock"==o&&TWMap.reservations[e.id]&&(o="mp_unlock"),"mp_fav"==o&&-1!=jQuery.inArray(parseInt(e.id),TWMap.targets)&&(o="mp_unfav"),"mp_farm_a"!=o&&"mp_farm_b"!=o||TWMap.context.FATooltip.init(o,e.id,a,t);var n=$("#"+o),r=parseFloat(n.css("opacity"))||1;if(n.css("left",s[0]+c[i][0]+"px").css("top",s[1]+c[i][1]+"px").stop().css("opacity",0).show().fadeTo(120,r),TWMap.urls.ctx[o]){var m=TWMap.urls.ctx[o].replace(/__village__/,e.id).replace(/__owner__/,e.owner).replace(/__source__/,game_data.village.id);m.match(/json=1/)?l.ajaxRegister(o,m):$("#"+o)[0].href=m,mobile||("mp_att"==o?$("#"+o).off("click").on("click",function(a){return!(1==a.which&&!a.ctrlKey&&!a.shiftKey)||(TWMap.inline_send.enabled?(TWMap.actionHandlers.command.click(e.id),!1):void 0)}):"mp_res"==o&&$("#"+o).off("click").on("click",function(a){return!(1==a.which&&!a.ctrlKey&&!a.shiftKey)||(TWMap.inline_send.enabled?(TWMap.actionHandlers.market.click(e.id),!1):void 0)}))}p.push(o)}}),this._curFocus=i,this._visible=!0},ajaxRegister:function(e,a){$("#"+e).unbind("click").click(function(t){t.preventDefault();var i=(new Date).getTime();if(!(this._last&&i-this._last<900))return this._last=i,TribalWars.get(a,null,function(a){TWMap.context.ajaxDone(e,a)}),!1})},ajaxDone:function(e,a){this.hide();var t=TWMap.fullscreen?$("#map_wrap"):null;switch(e){case"mp_lock":case"mp_unlock":if(!a.code){UI.ErrorMessage(a.error,null,t);break}a.notice&&UI.InfoMessage(a.notice,null,null,t),"mp_lock"===e?TWMap.reservations[a.village]="player":delete TWMap.reservations[a.village],TWMap.popup.invalidateCache(),TWMap.reload();break;case"mp_fav":case"mp_unfav":if(!a.code){UI.ErrorMessage(a.error,null,t);break}if("mp_fav"==e)UI.SuccessMessage(_("0313820c71668f1d90687f4763d945a2"),null,t),TWMap.targets.push(a.id);else{UI.SuccessMessage(_("c9f785292a87add33c4be1eb55774182"),null,t);var i=jQuery.inArray(a.id,TWMap.targets);-1!=i&&(TWMap.targets[i]=0)}break;case"mp_farm_a":case"mp_farm_b":if(a.error)UI.ErrorMessage(a.error,null,t);else if(a.success){if(TWMap.premium){if(TWMap.commandIcons[a.target_village]){var o=!1;$.each(TWMap.commandIcons[a.target_village],function(){if("attack"==this.img)return o=!0,!1}),o||TWMap.commandIcons[a.target_village].push({img:"attack"})}else TWMap.commandIcons[a.target_village]=[{img:"attack"}];TWMap.reload()}TWMap.popup.invalidateCache(),UI.InfoMessage(_("64ad195324ccc86d7d134532a71e9d40"),null,null,t)}break;case"mp_invite_hide":document.location.reload()}},hide:function(){this._visible&&($(".mp").stop().fadeTo(300,0,function(){TWMap.context._visible||$(".mp").hide()}),this._visible=!1,this._curFocus=-1)}},home:{active:!0,boundary:null,go_home:null,text:null,pointer:null,is_premium_account_hint_shown:!1,focus:function(){var e=game_data.village;TWMap.focusUserSpecified(e.x,e.y)},init:function(){this.active&&(this.createDisplayComponents(),this.updateDisplay())},createDisplayComponents:function(){var e=$('<div id="map_go_home_boundary"></div>'),a=$('<div id="map_go_home"></div>'),t=$('<div id="map_go_home_circle"></div>');t.on("click",TWMap.home.focus);var i=$('<div id="map_go_home_text">home</div>');t.append(i);var o=$('<div id="map_go_home_pointer"></div>');a.append(o),a.append(t),e.append(a),$("#map_wrap").append(e),this.boundary=$("#map_go_home_boundary"),this.go_home=$("#map_go_home"),this.text=$("#map_go_home_text"),this.pointer=$("#map_go_home_pointer")},pointHome:function(){var e=game_data.village,a=TWMap.map.getCenter();a={x:a[0],y:a[1]};var t=e.y-a.y,i=e.x-a.x,o=Math.atan2(t,i);this.pointer.css({transform:"rotate("+o+"rad)"})},updateDistance:function(){var e=game_data.village,a=TWMap.map.getCenter();a={x:a[0],y:a[1]};var t=Math.sqrt((e.x-a.x)*(e.x-a.x)+(e.y-a.y)*(e.y-a.y));this.text.text(Math.floor(t)),t>=15&&t<16&&this.advertisePremiumIfNeeded()},skirt:function(){var e=game_data.village,a=TWMap.map.getCenter();a={x:a[0],y:a[1]};var t=e.x*TWMap.map.scale[0],i=e.y*TWMap.map.scale[1],o=t-(TWMap.map.pos[0]+TWMap.map.size[0]/2),n=i-(TWMap.map.pos[1]+TWMap.map.size[1]/2),s=-Math.atan2(n,o);s<0&&(s=2*Math.PI+s);var l=this.getTopRightCornerAngle(),p="bottom";s<l||s>=2*Math.PI-l?p="right":s<=Math.PI-l?p="top":s<=Math.PI+l&&(p="left");var r={left:0+$("#map_coord_y_wrap").width(),top:0,right:TWMap.map.size[0]-50,bottom:TWMap.map.size[1]-50-$("#map_coord_x_wrap").height()},c=r.left,m=r.top;switch(p){case"left":c=r.left;break;case"right":c=r.right;break;case"bottom":m=r.bottom;break;case"top":default:c=r.left}if("right"==p||"left"==p){var u="right"==p?1:-1;m=TWMap.map.size[1]/2-u*(Math.tan(s)*(TWMap.map.size[0]/2)),m=Math.max(Math.min(m,r.bottom),r.top)}if("top"==p||"bottom"==p){u="top"==p?1:-1,c=TWMap.map.size[0]/2-u*(Math.tan(s+Math.PI/2)*(TWMap.map.size[1]/2));c=e.x<a.x?Math.max(c,r.left):Math.min(c,r.right)}this.go_home.css({left:c+"px",top:m+"px"})},updateDisplay:function(){if(this.active){var e=game_data.village;TWMap.map.inViewport(e.x,e.y)?this.go_home.hide():(this.go_home.show(),TWMap.home.updateDistance(),TWMap.home.pointHome(),TWMap.home.skirt())}},getTopRightCornerAngle:function(){var e=TWMap.map.size[0]/2,a=TWMap.map.size[1]/2;return Math.atan2(a,e)},advertisePremiumIfNeeded:function(){game_data.features.Premium.active||this.is_premium_account_hint_shown||this.mobile||($(".premium_account_hint").show().css({display:"inline-block"}),this.is_premium_account_hint_shown=!0)}},home_aura:{center_offsets:{1:{x:0,y:3},2:{x:0,y:0},3:{x:0,y:0},4:{x:0,y:0},5:{x:0,y:0},6:{x:0,y:0}},init:function(){var e=game_data.village,a=e.x*TWMap.map.scale[0],t=e.y*TWMap.map.scale[1],i=TWMap.map.getLevelForVillagePoints(e.points),o=this.center_offsets[i],n=document.createElement("div");$(n).css({position:"absolute",left:a-TWMap.map.bias-(56-TWMap.map.scale[0])/2+o.x,top:t-TWMap.map.bias-(62-TWMap.map.scale[1])/2+o.y,"z-index":4,width:56,height:62,"background-image":"url("+image_base+"/map/home.png)"}),TWMap.map.el.container.appendChild(n)}},getColorByPlayer:function(e,a,t){return this.players[e]&&this.players[e].sleep?TWMap.colors.sleep:t&&TWMap.villageColors[t]&&e!=game_data.player.id?TWMap.villageColors[t]:TWMap.playerColors[e]?TWMap.playerColors[e]:e==game_data.player.id?TWMap.colors.player:a&&TWMap.allyColors[a]?TWMap.allyColors[a]:game_data.player.ally>0&&a==game_data.player.ally?TWMap.colors.ally:TWMap.allyRelations[a]?TWMap.colors[TWMap.allyRelations[a]]:TWMap.friends[e]?TWMap.colors.friend:TWMap.colors.other},actionHandlers:{}};function TWMapStore(e,a){var t,i,o=e,n=1e3*a,s=new Array(o);for(t=0;t<o;t++)for(s[t]=new Array(o),i=0;i<o;i++)s[t][i]=null;this.get=function(e,a){var t=e/20%o,i=a/20%o,n=s[t][i],l=(new Date).getTime();return null===n||n[0]!==e||n[1]!==a?null:n[2]<l?(s[t][i]=null,null):n[3]},this.set=function(e,a,t){var i=e/20%o,l=a/20%o,p=(new Date).getTime()+n;s[i][l]=[e,a,p,t]}}$(function(){"use strict";TWMap.synchronizer={notify:function(e,a){this.handlers.hasOwnProperty(e)&&this.handlers[e](a)},handlers:{command_count:function(e){if(!TWMap.map||!TWMap.premium)return!1;var a=e.count>0;TWMap.updateCommandIcon(e.target_village,e.command_type,a),TWMap.popup.invalidateVillage(e.target_village.id)}}}}()),function(){"use strict";TWMap.GreatSiege={travel_dist_spy_only:null,travel_dist_general:null,_indexed_village_ids:{},setSiegeVillageIds:function(e){for(var a=0;a<e.length;a++){var t=e[a];this._indexed_village_ids[t]=t}},setDistances:function(e,a){this.travel_dist_spy_only=e,this.travel_dist_general=a},isSiegeVillage:function(e){return void 0!==this._indexed_village_ids[e]},getTravelDistanceToSiegeVillage:function(e){for(var a=void 0!==e.spy,t=0;t<window.game_data.units.length;t++){var i=window.game_data.units[t];"spy"!==i&&e[i]&&(a=!1)}return a?this.travel_dist_spy_only:this.travel_dist_general},getTravelDistanceFromSiegeVillage:function(e,a){return Math.max(a,this.getTravelDistanceToSiegeVillage(e))}}}(),TWMap.actionHandlers.command={click:function(e){CommandPopup.openRallyPoint({target:e})}},TWMap.actionHandlers.market={click:function(e){TribalWars.get("market",{ajax:"send",target:e},function(e){Dialog.show("popup_command",e.dialog),$("#market-send-form").on("submit",TWMap.actionHandlers.market.sendResources)})},sendResources:function(){var e=$(this).serializeArray();return TribalWars.post("market",{ajax:"confirm"},e,function(e){Dialog.show("map_market",e.dialog),$("#market-confirm-form").on("submit",TWMap.actionHandlers.market.confirmSendResources)}),!1},confirmSendResources:function(){var e=$(this).serializeArray();return TribalWars.post("market",{ajaxaction:"map_send"},e,function(e){Dialog.close(),UI.SuccessMessage(e.message)}),!1}};

;/**** game/mapcanvas.js ****/
var MapCanvas={box:3,watchTowers:[],selected_x:null,selected_y:null,church_radius_colors:[[0,0,0],[254,216,177],[253,173,92],[252,139,24]],init:function(){var a;if(this.churchData)for(a=0;a<this.churchData.length;a++)this.churchData[a][2]*=this.churchData[a][2]},createCanvas:function(a,t){var e=document.createElement("canvas");if(!e||!e.getContext)return null;var r=TWMap.map.scale,h=TWMap.map.sectorSize;e.id="map_canvas_"+a.x+"_"+a.y,e.className="church_radius_display",e.width=r[0]*h,e.height=r[1]*h,e.style.position="absolute",e.style.zIndex="10",a.appendElement(e,0,0);var i=e.getContext("2d");if(i.save(),TribalWars._settings.map_show_watchtower)for(J=0;J<this.watchTowers.length;J++){var l=this.watchTowers[J][0],s=this.watchTowers[J][1],n=this.watchTowers[J][2];if(this.circleCollidesWithSector({x:l+.5,y:s+.5,r:n},{x:a.x,y:a.y,w:TWMap.map.sectorSize,h:TWMap.map.sectorSize})){var o=TWMap.map.pixelByCoord(l,s),c=TWMap.map.pixelByCoord(a.x,a.y),p=o[0]-c[0],u=o[1]-c[1];i.beginPath(),MapCanvas.ellipse(i,p+TWMap.tileSize[0]/2,u+TWMap.tileSize[1]/2,n*TWMap.map.scale[0],n*TWMap.map.scale[1],0,0,2*Math.PI,!1),i.fillStyle="rgba(235, 38, 38, 0.1)",i.fill(),i.lineWidth=1,i.strokeStyle="#563f1e",i.stroke()}}var d=this.churchData,f=t.pmap[0],v=t.pmap[1];f.length<1&&(f=null);var M,y,m,w=e.offsetWidth/h,T=e.offsetHeight/h;i.scale(w/37.75,T/37.75);var B,g=TWMap.politicalMap.filter%8,W=TWMap.attackPlannerMode,I=!W&&TWMap.politicalMap.displayed&&16&TWMap.politicalMap.filter;for(W&&(B=AttackPlanner.getMapInfo()),y=a.y-1;y<a.y+h+1;y++)for(M=a.x-1;M<a.x+h+1;M++){if(W){var _=1e3*M+y;B&&TWMap.villages.hasOwnProperty(_)&&B[TWMap.villages[_].id]&&this.mapDrawCell(i,M-a.x,y-a.y,[!1,!1,!1,!1,!0,!1,!1,!1,!1],["255","255","255"],19,19,.6)}if(I){var x=M-t.x+1,C=y-t.y+1;_=x+22*C;if(f&&0!==f[_]){var S=x-1+22*(C-1),D=x+22*(C-1),b=x+1+22*(C-1),L=x-1+22*C,P=x+1+22*C,z=x-1+22*(C+1),G=x+22*(C+1),k=x+1+22*(C+1),R=x<1,q=x>=21,O=C<1,E=C>=21;if(1==g||f[_]==game_data.player.id){m=[R||O?0:f[S],O?0:f[D],q||O?0:f[b],R?0:f[L],f[_],q?0:f[P],R||E?0:f[z],E?0:f[G],E||q?0:f[k]];var Q,A=f[_],H=v[_];Q=TWMap.getColorByPlayer(A,H),this.mapDrawCell(i,M-a.x,y-a.y,m,Q,19,19,.6)}(1==g||2==g||4!=g&&v[_]==game_data.player.ally)&&(m=[R||O?0:v[S],O?0:v[D],q||O?0:v[b],R?0:v[L],v[_],q?0:v[P],R||E?0:v[z],E?0:v[G],E||q?0:v[k]],this.mapDrawCell(i,M-a.x,y-a.y,m,[0,0,0],5,19,1))}}if(TWMap.church.displayed&&d){for(m=[!1,!1,!1,!1,!1,!1,!1,!1,!1],J=0;J<d.length;J++){var N=d[J][0],j=d[J][1],F=d[J][2];m=[m[0]||this.churchInBound(M-1,y-1,N,j,F),m[1]||this.churchInBound(M,y-1,N,j,F),m[2]||this.churchInBound(M+1,y-1,N,j,F),m[3]||this.churchInBound(M-1,y,N,j,F),m[4]||this.churchInBound(M,y,N,j,F),m[5]||this.churchInBound(M+1,y,N,j,F),m[6]||this.churchInBound(M-1,y+1,N,j,F),m[7]||this.churchInBound(M,y+1,N,j,F),m[8]||this.churchInBound(M+1,y+1,N,j,F)]}this.mapDrawCell(i,M-a.x,y-a.y,m,[0,0,128],19,19,.5)}if(TWMap.church.possible_displayed)for(var J=0;J<TWMap.church.levels.length;J++){var K=[[MapCanvas.selected_x,MapCanvas.selected_y]];null!=MapCanvas.selected_x&&null!=MapCanvas.selected_y&&this.drawMapRadiusByLevel(i,K,a,M,y,TWMap.church.levels[J])}}return i.restore(),i=null,e=null,null},circleCollidesWithSector:function(a,t){var e=Math.abs(a.x-t.x-t.w/2),r=Math.abs(a.y-t.y-t.h/2);if(e>t.w/2+a.r)return!1;if(r>t.h/2+a.r)return!1;if(e<=t.w/2)return!0;if(r<=t.h/2)return!0;var h=e-t.w/2,i=r-t.h/2;return h*h+i*i<=a.r*a.r},mapDrawCell:function(a,t,e,r,h,i,l,s){0!==r[4]&&h&&(t=38*(t+.5),e=38*(e+.5),a.save(),a.translate(t,e),this.mapDrawBorderLine(a,this.mapGetSectorLine(r[3]==r[4],r[0]==r[4],r[1]==r[4],l),i,h,s),a.restore(),a.save(),a.translate(t,e),a.rotate(.5*Math.PI),this.mapDrawBorderLine(a,this.mapGetSectorLine(r[1]==r[4],r[2]==r[4],r[5]==r[4],l),i,h,s),a.restore(),a.save(),a.translate(t,e),a.rotate(Math.PI),this.mapDrawBorderLine(a,this.mapGetSectorLine(r[5]==r[4],r[8]==r[4],r[7]==r[4],l),i,h,s),a.restore(),a.save(),a.translate(t,e),a.rotate(1.5*Math.PI),this.mapDrawBorderLine(a,this.mapGetSectorLine(r[7]==r[4],r[6]==r[4],r[3]==r[4],l),i,h,s),a.restore())},mapDrawBorderLine:function(a,t,e,r,h){if(!(t.length<1)){for(var i,l,s,n,o,c,p,u,d,f,v,M,y,m,w,T,B,g=2,W=[],I=0;I<t.length-2;I+=2)i=t[I],l=t[I+1],s=t[I+2],n=t[I+3],p=(o=s-i)*o+(c=n-l)*c,u=Math.sqrt(p),W[I]=c/u,W[I+1]=-o/u;var _=a.globalCompositeOperation,x=a.fillStyle;for(h||(a.fillStyle="rgba("+r[0]+","+r[1]+","+r[2]+",.7)");null!=t[g+4];)i=t[g],l=t[g+1],s=t[g+2],n=t[g+3],w=W[g-2],T=W[g-1],v=W[g],M=W[g+1],y=W[g+2],m=W[g+3],d=v,f=M,y+=v,m+=M,v+=w,M+=T,(u=Math.sqrt(y*y+m*m))>0&&(y/=u,m/=u),(u=Math.sqrt(v*v+M*M))>0&&(v/=u,M/=u),h&&((B=a.createLinearGradient(i,l,i+d*e,l+f*e)).addColorStop(0,"rgba("+r[0]+","+r[1]+","+r[2]+","+h+")"),B.addColorStop(1,"rgba("+r[0]+","+r[1]+","+r[2]+",0)"),a.fillStyle=B),a.beginPath(),a.moveTo(i,l),a.lineTo(s,n),a.lineTo(s+y*e,n+m*e),a.lineTo(i+v*e,l+M*e),a.closePath(),a.fill(),g+=2;a.fillStyle=x,a.globalCompositeOperation=_}},mapGetSectorLine:function(a,t,e,r){var h=[],i=0,l=.9,s=19;return a||e?!a||e||t||(h[i++]=r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=-s,h[i++]=-r*l,h[i++]=2*-r,h[i++]=-r*l):(h[i++]=r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=.1*-r,h[i++]=-r*l,h[i++]=.35*-r*l,h[i++]=.95*-r*l,h[i++]=-r*Math.SQRT1_2*l,h[i++]=-r*Math.SQRT1_2*l,h[i++]=.95*-r*l,h[i++]=.35*-r*l,h[i++]=-r*l,h[i++]=.1*-r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=r),a&&!e&&t&&(h[i++]=r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=.2*-r,h[i++]=-r*l,h[i++]=.6*-r,h[i++]=-r,h[i++]=.2*r-s,h[i++]=-s-.2*r,h[i++]=2*-r,h[i++]=2.4*-r),a||!e||t||(h[i++]=-r*l,h[i++]=2*-r,h[i++]=-r*l,h[i++]=-s,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=r),!a&&e&&t&&(h[i++]=2.4*-r,h[i++]=2*-r,h[i++]=-s-.2*r,h[i++]=.2*r-s,h[i++]=-r,h[i++]=.6*-r,h[i++]=-r*l,h[i++]=.2*-r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=r),h},churchInBound:function(a,t,e,r,h){var i=a-e,l=t-r;return i*i+l*l<=h},ellipse:function(a,t,e,r,h,i,l,s,n){a.save(),a.translate(t,e),a.rotate(i),a.scale(r,h),a.arc(0,0,1,l,s,n),a.restore()},drawMapRadiusByLevel:function(a,t,e,r,h,i){for(var l=[!1,!1,!1,!1,!1,!1,!1,!1,!1],s=0;s<t.length;s++){var n=t[s][0],o=t[s][1],c=i>0?Math.pow(2+2*i,2):0;l=[l[0]||this.churchInBound(r-1,h-1,n,o,c),l[1]||this.churchInBound(r,h-1,n,o,c),l[2]||this.churchInBound(r+1,h-1,n,o,c),l[3]||this.churchInBound(r-1,h,n,o,c),l[4]||this.churchInBound(r,h,n,o,c),l[5]||this.churchInBound(r+1,h,n,o,c),l[6]||this.churchInBound(r-1,h+1,n,o,c),l[7]||this.churchInBound(r,h+1,n,o,c),l[8]||this.churchInBound(r+1,h+1,n,o,c)]}var p=i>3&&i<0?this.church_radius_colors[0]:this.church_radius_colors[i];this.mapDrawCell(a,r-e.x,h-e.y,l,p,19,19,.5)}};

;/**** game/boxtoggle.js ****/
function MapToggleBox(n){var i=$.extend({visible:!1,url:null,onShow:null,onHide:null},n);n=i;var o=this,e=i.id,t=i.visible,l=!1,u=i.url,s=$(document.getElementById(e)),h=$("."+e+"_wrap"),a=$("."+e+"_toggler");function c(){var n=TWMap.image_base+"/icons/slide_"+(t?"up":"down")+".png";a.attr("src",n)}function d(){null!==i.onShow&&i.onShow(),t=!0,c(),s.show("fast")}function r(n){l&&(l=!1,s.html(n),d())}this.show=function(){u?(l=!0,$.ajax({url:u,dataType:"html",success:r})):d()},this.hide=function(){!function(){null!==i.onHide&&i.onHide();t=!1,l=!1,c(),s.hide("fast")}()},t||(h.hide(),s.hide()),a.click(function(){return t?o.hide():o.show(),!1}),c()}

;/**** game/jstpl.js ****/
!function(){var t={};this.jstpl_format=function(t,n){for(var r=t,e=t.match(/%([^%]+)%/g),p=e.length,i=0;i<p;i++){var o=e[i].substring(1,e[i].length-1);r=r.replace(new RegExp(e[i]),n[o])}return r},this.jstpl=function n(r,e){var p=/\W/.test(r)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+r.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t==(.*?)%>/g,"',jstpl_format($1,obj),'").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):t[r]=t[r]||n(document.getElementById(r).innerHTML);return e?p(e):p}}();

;/**** game/TroopTemplates.js_ ****/
var TroopTemplates={current:null,loadTemplate:null,deleteLink:null,currentTemplates:0,maxTemplates:2,init:function(){var e=$("#troop_template_units");e.find('input[type="checkbox"]').change(TroopTemplates.allTroopsCheckbox),document.location.hash&&(TroopTemplates.loadTemplate=document.location.hash.substring(1)),TroopTemplates.currentTemplates>=TroopTemplates.maxTemplates?TroopTemplates.loadTemplate||(TroopTemplates.loadTemplate=!0):TroopTemplates.selectCreate(),TroopTemplates.updateTemplateList(),mobile||$("#troop_template_list").css("height",$("#troop_template_units").height()+"px"),$("#template_create").click(TroopTemplates.selectCreate),e.find("form").submit(TroopTemplates.validate),$("a.help-link").on("click",function(e){e.preventDefault(),TribalWars.get(game_data.screen,{ajax:"templates_help"},function(e){Dialog.show("help",e.dialog)})})},allTroopsCheckbox:function(){var e=mobile?"number":"text";this.parentElement.querySelector('input[type="'+e+'"]').disabled=this.checked},resetSelect:function(e){e.find("option:first").attr("selected","selected").parent("select")},useTemplate:function(e){if("object"==typeof e&&(e=$(e).find("option:selected").val()),e){var t=TroopTemplates.current[e];$.each(t,function(e,a){var l=$("#unit_input_"+e);l.length&&(a>=0?l.val(Math.min(parseInt(l.data("all-count")),a)):l.val(Math.max(0,parseInt(l.data("all-count"))+parseInt(a)))),t.use_all.indexOf(e)>-1&&l.val(l.data("all-count"))}),$("#template_id").val(e)}return!1},validate:function(){return $("#template_name").val().length<1?(UI.ErrorMessage(_("8a583c14eb4afc2ea2ac98a38eabb744")),!1):$("#template_name").val().length>50?(UI.ErrorMessage(_("4d2c639afe61e71f27518ee7b952436a")),!1):""!=$("#template_name").val().trim()||(UI.ErrorMessage(_("ad2e48bae3587249c07027ac3eb331a7")),!1)},updateTemplateList:function(){var e=$("#troop_template_list").find("ul"),t=1;$.each(TroopTemplates.current,function(a,l){l.sanitized_name=$("<a></a>").text(l.name).text(),l.display_name="";for(var p=0;p<l.sanitized_name.length;p++)l.display_name+=l.sanitized_name.charAt(p)+"&shy;";var o=$('<li><a href="#'+l.id+'"></a></li>'),n=o.find("a");n.data("template-id",l.id),n.data("li-id",t),n.click(TroopTemplates.selectTemplate),n.html(l.display_name),e.append(o);var r=$('<img src="/graphic/delete_14.png" alt="" />').click(function(e){e.stopPropagation(),document.location.replace(TroopTemplates.deleteLink+"&id="+l.id)});n.prepend(r),l.id!=TroopTemplates.loadTemplate&&!0!==TroopTemplates.loadTemplate||(TroopTemplates.selectTemplate.call(n),TroopTemplates.loadTemplate=0),t++})},selectCreate:function(e){if(void 0!==e&&e.preventDefault(),TroopTemplates.currentTemplates>=TroopTemplates.maxTemplates)return UI.ErrorMessage(_("c61cdbdae723805bf8dccf2bf9bcfec5")),!1;var t=$("#troop_template_units"),a=t.find('input[type="checkbox"]');a.prop("checked",!1),a.trigger("change");var l=mobile?"number":"text";t.find("input[type="+l+"]").val(""),$("#template_id").val(0),$("#template_name").val(""),$("#template_button").val(_("f6da9639891b32492ee35a12286e301b")),TroopTemplates.setSelected(0)},selectTemplate:function(){var e=$(this),t=e.data("template-id"),a=e.data("li-id"),l=TroopTemplates.current[t];TroopTemplates.setSelected(a),$("#template_id").val(l.id),$("#template_name").val(l.name),$("#template_button").val(_("2992dafa14a7361deb8459ad07659b12")),$.each(l,function(e,t){var a=$("#unit_input_"+e),p=a.parent().find('input[type="checkbox"]');a.length&&a.val(t),p.prop("checked",l.use_all.indexOf(e)>-1),p.trigger("change")})},setSelected:function(e){var t=$("#troop_template_list").find("li");t.removeClass("selected"),t.eq(e).addClass("selected")}};

;/**** game/TargetSelection.js_ ****/
var TargetSelection;!function(){"use strict";(TargetSelection=function(e){var t=this;this.$container=null,this.on_confirm_village=function(e){},this.request_id=0,this.selected_index=null,this.num_villages=0,this.page_limit=null,this.last_attacked=null,this.autocomplete_visible=!1,this.ie_compatibility_mode=!0,this.confirmed_village_data=!1,this.read_only=!1,this.clicked_button="attack",this.autocomplete_wrapper=null,this.input_text_field=null,this.script_watcher=null,this.script_old_x="",this.script_old_y="",this.construct=function(e){var i=$(e);this.$container=i,this.input_text_field=i.find("input[type=text]"),this.initAutoComplete(),this.changeSearchType.call(i.find("input[type=radio]:checked"),!1),this.page_limit=Math.min(Math.max(Math.round(($(window).height()-this.input_text_field.offset().top)/50),5),10),this.setAutoCompleteWrapperPosition(),this.input_text_field.on("input",function(){t.ie_compatibility_mode=!1,t.fetchVillages()}).on("keyup",t.textFieldKeyUp).on("keydown",t.textFieldKeyDown).on("remove",t.destroy),i.find("input[type=radio]").on("change",this.changeSearchType),this.input_text_field.parents("form").on("submit",this.beforeSubmit),$(window).on("click",this.onWindowClick),i.find(".btn").on("click",function(){t.clicked_button=$(this).attr("name")});var a=i.data("on-choice");a&&this.setConfirmHook(a)},this.destroy=function(){clearInterval(t.script_watcher),$(window).off("click",t.onWindowClick),this.input_text_field=null},this.onWindowClick=function(){t.autocomplete_visible&&t.hideAutoCompleteWrapper()},this.initAutoComplete=function(){this.$container.find(".target-input-autocomplete").autocomplete({minLength:2,source:UI.AutoComplete.source}),this.input_text_field.on("autocompleteselect",function(e,i){t.fetchVillages({input:i.item.value})})},this.initScriptCompatibility=function(){clearInterval(this.script_watcher),this.script_watcher=setInterval(this.checkForScriptChange,100)},this.checkForScriptChange=function(){var e=parseInt($("#inputx").val()),i=parseInt($("#inputy").val()),a=parseInt(t.confirmed_village_data?t.confirmed_village_data.x:0),l=parseInt(t.confirmed_village_data?t.confirmed_village_data.y:0);e&&i&&(e!==a||i!==l)&&(clearInterval(t.script_watcher),t.setVillageByCoordinates(e,i,function(){$("#inputx").val(""),$("#inputy").val(""),t.initScriptCompatibility()}))},this.setReadOnly=function(){this.read_only=!0},this.setLastAttacked=function(e){this.last_attacked=e,this.$container.find(".target-last-attacked").show().on("click",function(e){e.preventDefault(),t.confirmVillage(t.getVillageDiv(t.last_attacked))})},this.enableQuickButton=function(e,t){$(".target-"+e).show().on("click",function(e){TargetSelection.loadTargetsPopup(e,t)})},this.setVillageByCoordinates=function(e,i,a){this.fetchVillages({type:"coord",input:e+"|"+i},function(e){e.villages.length&&t.confirmVillage(t.getVillageDiv(e.villages[0])),"function"==typeof a&&a()})},this.setVillageByData=function(e){this.confirmVillage(t.getVillageDiv(e)),$("#inputx").val(e.x),$("#inputy").val(e.y)},this.beforeSubmit=function(){var e,i=$("#inputx"),a=$("#inputy"),l=t.$container.find(".target-input .village-item");if(l.length){var n=l.data("village_data");i.val(n.x),a.val(n.y)}return(e=t.$container.find("input[type=text]").val().match(/^([0-9]{1,3})\|([0-9]{1,3})$/))&&(i.val(e[1]),a.val(e[2])),!0},this.changeSearchType=function(e){var i,a=$(this),l=a.closest(".target-select").find("input[type=text]");switch(a.val()){case"coord":i="123|456";break;case"village_name":i=_("0b0415688c7513bb82d3c0e0835bd002");break;case"player_name":i=_("8db61ba8bc85fde639110b3098e827bb")}l.attr("placeholder",i).data("search-type",a.val()),t.clearVillages(),"player_name"===a.val()?(l.autocomplete("enable"),l.autocomplete("search")):l.autocomplete("disable"),!1!==e&&l.focus()},this.clearVillages=function(){this.hideAutoCompleteWrapper(),this.removeConfirmedVillage()},this.fetchVillages=function(e,i){var a={ajax:"target_selection",input:this.$container.find("input[type=text]").val(),type:this.$container.find("input[type=radio]:checked").val(),request_id:++this.request_id,limit:this.page_limit,offset:0};0!==(a=$.extend(a,e)).input.length&&(void 0===i&&(i=function(e){t.handleVillagesData(e)}),TribalWars.get("api",a,i))},this.handleVillagesData=function(e){if(e.request_id===this.request_id){var i=this.getAutoCompleteWrapper();if(this.hideAutoCompleteWrapper(),this.num_villages=e.villages.length+e.offset,0===e.offset?(this.selected_index=null,i.empty()):i.find(".village-more").remove(),0!==e.villages.length){if(this.showAutoCompleteWrapper(),$.each(e.villages,function(e,a){i.append(t.getVillageDiv(a))}),e.more){var a=$('<div class="village-item village-more">'+_("146ffe2fd9fa5bec3b63b52543793ec7")+"</div>").on("click",function(e){e.stopPropagation(),t.loadMoreVillages()});i.append(a)}this.setAutoCompleteWrapperPosition()}}},this.showAutoCompleteWrapper=function(){this.getAutoCompleteWrapper().show(),this.autocomplete_visible=!0},this.hideAutoCompleteWrapper=function(){"player_name"===this.$container.find(".input[type=radio]:checked").val()&&this.input_text_field.autocomplete("enable"),this.getAutoCompleteWrapper().hide(),this.autocomplete_visible=!1},this.getAutoCompleteWrapper=function(){return this.autocomplete_wrapper||(this.autocomplete_wrapper=$('<div class="target-select-autocomplete"></div>').appendTo("body")),this.autocomplete_wrapper},this.setAutoCompleteWrapperPosition=function(){var e=this.getAutoCompleteWrapper(),t=this.$container.find(".target-input"),i=t.offset(),a=t.height();e.css("width",t.width()+2+"px"),e.css("max-height",50*this.page_limit+"px"),e.css("left",i.left);var l=e.height();l>$(document).height()-i.top-a-$("#footer").height()?(e.css("top",i.top-l-2+"px"),e.css({"border-top-width":"1px","border-bottom-width":"0px"})):(e.css("top",i.top+a+2+"px"),e.css({"border-top-width":"0px","border-bottom-width":"1px"}))},this.setConfirmHook=function(e){for(var t=e.split("."),i=t.pop(),a=window,l=0;l<t.length;l++)a=a[t[l]];var n=a[i];if("function"!=typeof n)throw"non-existent function specified for TargetSelection on-choice";this.on_confirm_village=n},this.confirmVillage=function(e){this.removeConfirmedVillage(),this.getAutoCompleteWrapper().hide();var t=this.$container.find(".target-input");t.find("input").hide(),t.append(e),e.removeClass("village-selected"),this.confirmed_village_data=e.data("village_data"),this.updateURLForConfirmedVillage(),this.on_confirm_village(this.confirmed_village_data)},this.removeConfirmedVillage=function(){var e=this.$container.find(".target-input");e.find(".village-item").length&&(e.find("input").show().val("").focus(),e.find(".village-item").remove(),this.confirmed_village_data=!1,$("input[name=x], input[name=y]").val(""),this.updateURLForConfirmedVillage())},this.getVillageDiv=function(e){var i=$('<div class="village-item"><img class="village-delete" alt="" /><img class="village-picture" alt="" /><span class="village-name"></span><span class="village-info"></span><span class="village-distance"></span></div>').data("village_data",e);this.read_only||i.on("click",function(e){e.stopPropagation(),$(this).parent().hasClass("target-select-autocomplete")?t.confirmVillage(i):t.removeConfirmedVillage()});var a=e.name;a.length>18&&(a=a.substr(0,18)+"&hellip;");var l=s("%1 (%2|%3)",a,e.x,e.y),n=e.player_name?e.player_name:_("0a697cba19cd4c1974e2ee11a3c0b9c7"),o="<strong>"+_("13c5c6614ffee1464fd8f257d23151a4")+"</strong> "+n+" <strong>"+_("bde4bea69ecac47075ec76f575513829")+"</strong> "+e.points,c=Math.round(Math.sqrt(e.distance)),r=1===c?s(_("ba2b365358d84111ebec5eab11ed9676"),c):s(_("b7e6ef7cb6adca76ea4a73f1b0e4c3b7"),c),d="<strong>"+_("d7ecc20be02635c8fd9ba717df02a66b")+"</strong> "+r,p=i.find(".village-picture");return p.attr("src",e.image),e.siege_village&&p.addClass("siege-village"),i.find(".village-delete").attr("src",image_base+"/delete.png"),i.find(".village-name").html(l),i.find(".village-info").html(o),i.find(".village-distance").html(d),this.read_only&&i.addClass("read-only"),i},this.textFieldKeyUp=function(e){t.ie_compatibility_mode&&38!==e.keyCode&&40!==e.keyCode&&t.fetchVillages();var i=$(this),a=i.val();return"coord"===i.data("search-type")&&(3===(a=(a=a.replace(/[,.]/,"|")).replace(/[^[0-9|]+/,"")).length&&8!==e.keyCode&&46!==e.keyCode&&(a+="|"),-1!==a.indexOf("||")&&(a=a.replace(/(\|{2,})/,"|")),a.length>7&&(a=a.substr(0,7)),i.val(a)),!0},this.textFieldKeyDown=function(e){return 38===e.keyCode?(t.selectPrevVillage(),!1):40===e.keyCode?(t.selectNextVillage(),!1):13!==e.keyCode||(t.confirmVillageAtIndex(t.selected_index),!1)},this.selectNextVillage=function(){null===this.selected_index?this.selectVillageAtIndex(0):this.selected_index+1<=this.num_villages&&this.selectVillageAtIndex(this.selected_index+1)},this.selectPrevVillage=function(){null!==this.selected_index&&this.selected_index>0&&this.selectVillageAtIndex(this.selected_index-1)},this.selectVillageAtIndex=function(e){this.unselectSelectedVillage();var t=this.getAutoCompleteWrapper().find("div").eq(e);t.addClass("village-selected"),this.selected_index=e;var i=41*e,a=t.position().top,l=parseInt(t.parent().css("max-height"));a<10?t.parent().scrollTop(i):a>l-40&&t.parent().scrollTop(i)},this.unselectSelectedVillage=function(){this.getAutoCompleteWrapper().find("div.village-selected").removeClass("village-selected")},this.confirmVillageAtIndex=function(e){var t=this.getAutoCompleteWrapper().find("div").eq(e);t.length&&(t.hasClass("village-more")?(this.loadMoreVillages(),this.selectVillageAtIndex(e-1)):this.confirmVillage(t))},this.updateURLForConfirmedVillage=function(){var e=this.confirmed_village_data?this.confirmed_village_data:{id:0},t=document.location.href;"#"===t.substr(-1)&&(t=t.substr(0,t.length-1));var i=/target=([0-9]+)/;t.match(i)?t=t.replace(i,"target="+e.id):t+="&target="+e.id,Modernizr.history&&history.replaceState({},"",t)},this.loadMoreVillages=function(){this.fetchVillages({offset:this.num_villages})},this.construct(e)}).loadTargetsPopup=function(e,t){UI.AjaxPopup(e,"village_targets",t,_("91fadc5613280f76b916f1fd236e43e9"),null,{reload:!0},null,400)}}();

;/**** game/worldmap.js ****/
var Worldmap={Data:{t:0},init:function(e){Worldmap.Data.t=e,$("#worldmap").draggable({stop:Worldmap.savePosition,containment:[0,60]})},toggle:function(){switch("undefined"==typeof toggle_value||0==toggle_value?("undefined"==typeof toggle_value&&Worldmap.reload(),toggle_value=!0):toggle_value=!1,toggle_value){case!0:$("#worldmap").show();break;case!1:$("#worldmap").hide()}},reload:function(){var e="&cut=true";$("#worldmap_settings").children(":checked").each(function(){switch($(this).attr("name")){case"worldmap_barbarian_toggle":e+="&barbarian=true";break;case"worldmap_ally_toggle":e+="&ally=true";break;case"worldmap_partner_toggle":e+="&partner=true";break;case"worldmap_nap_toggle":e+="&nap=true";break;case"worldmap_enemy_toggle":e+="&enemy=true"}}),Worldmap.Data.t>0&&(e=e+"&t="+Worldmap.Data.t),Worldmap.loadMapImage(e)},loadMapImage:function(e){$("#worldmap_body").hide(),$("#worldmap-throbber").show();var t=new Image;t.onload=function(){$("#worldmap-throbber").hide(),$("#secrets").css("left",(this.width-1e3)/2).css("top",(this.height-1e3)/2);var e=500-this.width/2,t=500-this.height/2;$("#worldmap_image > input").width(this.width).height(this.height).click(function(a){var o=$(this).offset(),r=a.offsetX?a.offsetX:a.pageX-this.offsetLeft-o.left,l=a.offsetY?a.offsetY:a.pageY-this.offsetTop-o.top;return r+=e,l+=t,Worldmap.toggle(),TWMap.map.centerPos(r,l),!1}),$("#worldmap_body").width(this.width).height(this.height).css("background-image","url("+this.src+")").show()},t.src="page.php?page=worldmap_image"+e},savePosition:function(e,t){$.cookie("worldmap_left",$(this).css("left")),$.cookie("worldmap_top",$(this).css("top"))}};

;/**** game/Market.js_ ****/
var Market={Data:{Trader:{carry:0,amount:0,total:0,capacity:null},Res:{wood:0,stone:0,iron:0}},Memory:{freeCapacity:null,res:{wood:0,stone:0,iron:0}},Set:{freeCapacitiy:function(e){Market.Memory.freeCapacity=e},maxRes:function(e){Market.Memory.res=e,Market.Data.Res.wood=e.wood,Market.Data.Res.stone=e.stone,Market.Data.Res.iron=e.iron}},init:function(e,t){Market.Data=e,Market.Modes[t]&&Market.Modes[t].init(),$("#unblocked_points_info").on("click",function(){Dialog.fetch("premium_blocked_logs","premium",{ajax:"blocked_points"})})},getPremiumRate:function(e,t){var a=e/t;return{resources:0===a?0:a<1?1:Math.floor(a),premium:0===a?0:a<1?Math.floor(1/a):1}},Modes:{own_offer:{init:function(){Market.Modes.own_offer.initResSelectionHandling()},initResSelectionHandling:function(){$("#res_sell_wood, #res_sell_stone, #res_sell_iron").click(function(){$("#res_sell_amount").select()}),$("#res_buy_wood, #res_buy_stone, #res_buy_iron").click(function(){$("#res_buy_amount").select()})}},all_own_offer:{init:function(){$(".fillmax").click(function(){return Market.Modes.all_own_offer.fillMax(this),!1}),$("a.market_accept_offer").click(function(){Market.Modes.all_own_offer.submitOfferAcceptForm($(this))}),$("input.market_accept_offer").keydown(function(e){13===e.keyCode&&(e.preventDefault(),$(this).parent().find("a.market_accept_offer").click())})},acceptOffer:function(e,t){TribalWars.post("market",{ajaxaction:"accept_offer"},{id:e,count:t},function(t){var a=Market.Modes.all_own_offer;t.hasOwnProperty("expired")?(UI.ErrorMessage(t.expired),a.removeOfferDisplay()):(UI.SuccessMessage(_("78b7d007dca3267f751240a2a365ce25")),0===t.offers_remaining?a.removeOfferDisplay(e):a.updateOffer(e,t.offers_remaining),a.updateMerchants(t.merchants_available,t.merchants_total,t.merchant_carry))})},submitOfferAcceptForm:function(e){var t=e.data("id"),a=e.parent().find("input[name=count]").val();return this.acceptOffer(t,a),!1},removeOfferDisplay:function(e){$offer_container=$("#offer_"+e);var t=$offer_container.data("village"),a=$("#village_"+t),r=a.data("offer-count")-1;if(a.data("offer-count",r),mobile)$offer_container.next().remove(),$offer_container.prev().remove(),r<1&&(a.next().remove(),a.remove());else{a.attr("rowspan",parseInt(a.attr("rowspan"))-1);var o=$offer_container.next(".offer_container");o[0]&&o.data("village")===t&&o.prepend(a.detach())}$offer_container.remove()},updateOffer:function(e,t){$offer_container=$("#offer_"+e),$offer_container.data("count",t),$("#offer_count_"+e).html(t)},updateMerchants:function(e,t,a){var r=Math.floor(e*a),o=game_data.village;$(".offer_container").each(function(){var e=$(this),t=e.data("id"),a={wood:e.data("wanted_wood"),stone:e.data("wanted_stone"),iron:e.data("wanted_iron")},i=e.data("count"),n=0,f=0;["wood","stone","iron"].forEach(function(e){n+=a[e],a[e]>0&&(f=Math.floor(o[e]/a[e]))});var s=n>0?Math.floor(r/n):0,l=Math.min(f,s,i);$fillmax=$("#fillmax_"+t),$fillmax.html(l).data("max",l)})},fillMax:function(e){$anchor=$(e),$anchor.parent().find("input[name=count]").val($anchor.data("max"))}},other_offer:{init:function(){$("input[name=res_sell], input[name=res_buy]").change(Market.Modes.other_offer.check_ratio_enabled),$("form.market_accept_offer").submit(function(){Market.Modes.other_offer.submitOfferAcceptForm($this)}),Market.Modes.other_offer.check_ratio_enabled(),$("#offer_filter select, #offer_filter input[name=only_ally]").change(function(){Market.Modes.other_offer.search()}),$("#confirm_custom_ratio_max").click(function(){Market.Modes.other_offer.search()}),$(".evt-market-swap-res").on("click",function(){$("input[name=swap]").val("1"),Market.Modes.other_offer.search()})},check_ratio_enabled:function(){$("input[name=res_sell]").each(function(){this.checked&&this.value}),$("input[name=res_buy]").each(function(){this.checked&&this.value})},lockSell:function(e){$('input[name="res_sell"]').prop("disabled",!1),$('#selection_sell :input[value="'+e+'"]').prop("disabled",!0),this.search()},lockBuy:function(e){$('input[name="res_buy"]').prop("disabled",!1),$('#selection_buy :input[value="'+e+'"]').prop("disabled",!0),this.search()},switchToCustomRatioUI:function(){$("#choose_ratio_max").remove(),$("#custom_ratio_max").show(),$("#custom_ratio_max_input").attr("name","ratio_max").select()},sort:function(e){e===$("#order_by").val()&&$("#toggle_dir").val(1),$("#order_by").val(e),this.search()},search:function(){$("#offer_filter").submit()},acceptOffer:function(e,t){TribalWars.post("market",{ajaxaction:"accept_offer"},{id:e,count:t},function(e){e.hasOwnProperty("expired")?UI.ErrorMessage(e.expired):UI.SuccessMessage(_("78b7d007dca3267f751240a2a365ce25")),partialReload()})},submitOfferAcceptForm:function(e){var t=e.find("input[name=id]").val(),a=e.find("input[name=count]").val();return this.acceptOffer(t,a),!1}},send:{init:function(){$("input.resources_max").change(Market.Modes.send.handleChange),$("#fill_recent_target").click(function(){var e=$(this);return Market.Modes.send.setCoords(e.data("x"),e.data("y")),!1})},setCoords:function(e,t){return $("#inputx").val(e),$("#inputy").val(t),!1},handleChange:function(e){Market.Modes.send.recalcFreeCapacity()},insertMax:function(e){var t=$("input[name='"+e+"']"),a=parseInt(t.val());isNaN(a)&&(a=0),null==Market.Memory.freeCapacity&&Market.Modes.send.recalcFreeCapacity();var r=0;(r=Market.Memory.freeCapacity>Market.Memory.res[e]?Market.Memory.res[e]:Market.Memory.freeCapacity)<=0?(r=0,Market.Memory.res[e]=Market.Data.Res[e]):r+=a,Market.Memory.res[e]-=r,0==r&&(r=""),t.val(r),Market.Modes.send.recalcFreeCapacity()},recalcFreeCapacity:function(){var e=0;$("input.resources_max").each(function(){var t=this.name,a=Math.max(0,parseInt($(this).val(),10));-1!=$(this).val().indexOf("k")&&(a*=1e3),isNaN(a)?a=0:$(this).val(a),e+=a,Market.Memory.res[t]=Market.Data.Res[t]-a});var t=Market.Data.Trader.capacity()-e;Market.Set.freeCapacitiy(t),Market.Modes.send.Alter.freeCapacity()},Alter:{freeCapacity:function(){$("a.insert").each(function(){var e=$(this).data("res"),t=Market.Memory.res[e],a=0;a=t<Market.Memory.freeCapacity?t:Market.Memory.freeCapacity;var r=$('input.resources_max[name="'+e+'"]');a<0?($(r).css("color","red"),a=0):$(r).css("color",""),$(this).text("("+a+")")})}}},mass_create_offers:{group_id:0,villages:{},lock_create:!1,lock_fill:!1,default_offer:{sell_value:"",sell_type:"wood",buy_value:"",buy_type:"wood",count:0,max_time:5},init:function(){var e=this;$("#template_save_button").click(function(t){t.preventDefault(),e.saveTemplate(e.readTemplate())}),$("#offer_fill_button").click(function(t){t.preventDefault(),e.fillFromTemplate(e.readTemplate())}),$("#market_offers").submit(function(t){t.preventDefault(),e.createOffers()}),$("#offer_sell_type, #offer_buy_type").width(Math.max($("#offer_sell_type").width(),$("#offer_buy_type").width()))},initForReal:function(){Object.keys(this.villages).length>0&&this.initVillageForm()},displayCreationErrors:function(e){var t='<div class="error_box"><div class="content">'+_("c5cb67f0b95f090ae2f9d1958d16f370")+"<ul>";$.each(e,function(e,a){t+="<li>"+escapeHtml(a)+"</li>"}),t+="</ul></div></div>",$("#offer_creation_errors").html(t)},hideCreationErrors:function(){$("#offer_creation_errors").html("")},updateVillageInfo:function(e){$("#village_info_res_"+e.id).html(e.res_string),$("#village_info_storage_"+e.id).html(Format.number(e.storage_max)),$("#village_info_traders_"+e.id).html(e.trader_free+"/"+e.trader_max),this.villages[e.id]=e},resetVillageOffer:function(e){this.setVillageOffer(e,this.default_offer)},setVillageOffer:function(e,t){Object.getOwnPropertyNames(t).forEach(function(a){$("#offer_"+a+"_"+e).val(t[a])})},readTemplate:function(){return{sell_value:parseInt($("#offer_sell_value").val())||0,sell_type:$("#offer_sell_type").val(),buy_value:parseInt($("#offer_buy_value").val())||0,buy_type:$("#offer_buy_type").val(),count:parseInt($("#offer_count").val())||0,max_time:parseInt($("#offer_max_time").val())||0,buffer_wood:parseInt($("#offer_buffer_wood").val())||0,buffer_stone:parseInt($("#offer_buffer_stone").val())||0,buffer_iron:parseInt($("#offer_buffer_iron").val())||0,buffer_trader:parseInt($("#offer_buffer_trader").val())||0}},saveTemplate:function(e){var t=$.extend({group_id:this.group_id},e);TribalWars.post("market",{ajaxaction:"save_offer_creation_template"},t,function(e){UI.SuccessMessage(_("55392dda51628cc7223acbdb6ef2ba21"))})},fillFromTemplate:function(e){if(!this.lock_fill){this.lockFill();var t=this,a=function(){t.unlockFill()};if(e.sell_type===e.buy_type)return UI.ErrorMessage(_("48da431332c8f7200e8380d37db87c5a")),void a();if(e.max_time<1||e.max_time>96)return UI.ErrorMessage(_("af9e24f1816a566658089aaef7a52c52")),void a();setTimeout(function(){$.each(t.villages,function(a,r){var o=e.sell_type;if("greatest"===o){var i=-1;Resources.types.forEach(function(e){r[e]>i&&(o=e,i=r[e])})}var n=e.buy_type;if("least"===n){var f=99999999;Resources.types.forEach(function(e){r[e]<f&&(n=e,f=r[e])})}if(o!=n){var s=r[o],l=e["buffer_"+o],c=Math.max(0,s-l),_=Math.floor(c/e.sell_value),u=Math.max(0,r.trader_free-e.buffer_trader),d=Math.ceil(e.sell_value/r.trader_carry),m=Math.floor(u/d),p=Math.min(e.count,_,m);p<1?t.resetVillageOffer(a):t.setVillageOffer(a,{count:p,sell_value:e.sell_value,sell_type:o,buy_value:e.buy_value,buy_type:n,max_time:e.max_time})}else t.resetVillageOffer(a)}),a()},1)}},createOffers:function(){if(!this.lock_create){this.hideCreationErrors(),this.lockCreate();var e=0;if($.each(this.villages,function(t,a){$("#offer_count_"+t).val()>0&&e++}),0===e)return this.unlockCreate(),void UI.ErrorMessage(_("0ec7b8af9110d483cd4adf024dfdd796"));var t=this,a=$("#mass_offer_creation"),r=$("#offer_creation_creating"),o=a.find(".blocker");r.show(),o.show(),a.css("opacity",.4);var i=function(){t.unlockCreate(),o.hide(),a.css("opacity",1),r.hide()};TribalWars.post("market",{ajaxaction:"mass_create_offers"},$("#market_offers").serializeArray(),function(e){var a=Object.keys(e.villages),r=0,o=function(){for(;r<a.length;){var n=a[r];if(t.updateVillageInfo(e.villages[n]),void 0!==e.successful_offers[n]&&t.resetVillageOffer(n),++r%50==0)break}r===a.length?($.isEmptyObject(e.village_errors)||t.displayCreationErrors(e.village_errors),i(),e.success_message?UI.SuccessMessage(e.success_message):$.isEmptyObject(e.village_errors)&&UI.ErrorMessage(_("6702ed629cdae1de9cf1afdb7441ef6c"))):setTimeout(function(){o()},1)};o()},function(){i()})}},lockCreate:function(){this.lock_create=!0,$("#market_offers").find(".btn_offer_create").prop("disabled",!0)},unlockCreate:function(){this.lock_create=!1,$("#market_offers").find(".btn_offer_create").prop("disabled",!1)},lockFill:function(){this.lock_fill=!0,$("#offer_fill_button").addClass("btn-disabled")},unlockFill:function(){this.lock_fill=!1,$("#offer_fill_button").removeClass("btn-disabled")},initVillageForm:function(){var e=this,t=$("#offer_creation_loading"),a=t.find(".mass-progress div"),r=$("#mass_offer_creation"),o=$("#offer_creation_villages").find("tbody");this.lockFill(),this.lockCreate();var i=Object.keys(e.villages),n=0,f=function(){for(;n<i.length;){var s=i[n];if(o.append(e.genVillageRow(e.villages[s])),n++,a.width(n/i.length*100+"%"),n%30==0)break}n===i.length?(e.unlockFill(),e.unlockCreate(),t.hide(),r.find(".blocker").hide(),r.css("opacity",1)):setTimeout(function(){f()},1)};f()},genVillageRow:function(e){var t=e;return"<tr><td>"+t.village+'</td><td id="village_info_res_'+t.id+'">'+t.res_string+'</td><td id="village_info_storage_'+t.id+'">'+Format.number(t.storage_max)+'</td><td id="village_info_traders_'+t.id+'">'+t.trader_free+"/"+t.trader_max+'</td><td><table class="vis">'+this.genResSelect(_("1d6f8052d9fe441bd9e7dd4261191cab"),"sell",t.id)+this.genResSelect(_("e77711cc92bbb8bb0bcfb9453706640f"),"buy",t.id)+'</table></td><td><input id="offer_count_'+t.id+'" name="offers['+t.id+'][count]" type="text" value="0" style="width:50px"> '+_("9461bed8b71377318436990e57106729")+'</td><td><input id="offer_max_time_'+t.id+'" name="offers['+t.id+'][max_time]" type="text" value="'+this.default_offer.max_time+'" style="width:50px"> '+_("6a7e73161603d87b26a8eac49dab0a9c")+"</td></tr>"},genResSelect:function(e,t,a){return'<tr><td style="white-space:nowrap">'+e+'</td><td><input id="offer_'+t+"_value_"+a+'" name="offers['+a+"]["+t+'_value]" type="text" style="width:50px"></td><td><select id="offer_'+t+"_type_"+a+'" name="offers['+a+"]["+t+'_type]">'+$.map(Resources.names,function(e,t){return'<option value="'+t+'">'+e+"</option>"}).join("")+"</select></td></tr>"}}},AjaxRequest:{changeMaxTime:function(e,t,a,r){$.ajax({type:"POST",url:e,data:{text:parseInt(t)},dataType:"json",success:function(e){e.error?UI.ErrorMessage(e.error,3e3):e.success&&$(a).html(e.max_time_string),$(r).val(e.max_time_value)}})}}};

;/**** game/MapHighlighter.js_ ****/
var MapHighlighter;!function(){"use strict";MapHighlighter={colorVillage:function(l){var a=l.owner>0&&TWMap.players[l.owner]?TWMap.players[l.owner].ally:0,e=TWMap.getColorByPlayer(l.owner,a,l.id);$("#map_village_"+l.id).css("background-color","rgb("+e[0]+","+e[1]+","+e[2]+")")},colorPlayer:function(l){$.each(TWMap.villages,function(a,e){parseInt(e.owner)===parseInt(l)&&MapHighlighter.colorVillage(e)})},colorAlly:function(l){$.each(TWMap.players,function(a,e){parseInt(e.ally)===parseInt(l)&&MapHighlighter.colorPlayer(a)})},colorAll:function(l,a,e){$.each(l,function(l,a){void 0!==TWMap.villageKey[a]&&MapHighlighter.colorVillage(TWMap.villages[TWMap.villageKey[a]])}),$.each(a,function(l,a){MapHighlighter.colorPlayer(a)}),$.each(e,function(l,a){MapHighlighter.colorAlly(a)})},alterVillage:function(l,a){null!==a?TWMap.villageColors[l]=a:delete TWMap.villageColors[l]},alterPlayer:function(l,a){null!==a?TWMap.playerColors[l]=a:delete TWMap.playerColors[l]},alterAlly:function(l,a){null!==a?TWMap.allyColors[l]=a:delete TWMap.allyColors[l]},alterAll:function(l,a,e){TWMap.allyColors=e,TWMap.playerColors=a,TWMap.villageColors=l}}}();

;/**** game/MapLegend.js ****/
var MapLegend;!function(){"use strict";MapLegend={CATEGORY_STANDARD:"standard",CATEGORY_TRIBAL:"tribal",CATEGORY_OWN:"own",CATEGORY_OTHER:"other",$container:null,init:function(){this.$container=$("#map_legend")},addHighlight:function(t,i,a,n,e){var d=$("<div>").addClass("map_legend").attr("data-active",1).attr("data-id",i),o=$("<div>");n&&o.css("background-color","rgb("+n.r+","+n.g+","+n.b+")"),e&&o.css({"background-image":'url("'+e+'")',"background-size":"15px 15px"}),d.append(o),d.append(" <span>"+escapeHtml(a)+"</span>"),this.$container.find('[data-category="'+t+'"]').find("td:nth-child(2)").append(d)},removeHighlight:function(t,i){this.$container.find('[data-category="'+t+'"]').find('[data-id="'+i+'"]').remove(),this.updateVisibility()},updateHighlight:function(t,i,a,n,e){var d=this.$container.find('[data-category="'+t+'"]').find('[data-id="'+i+'"]'),o=d.find("div"),c=n?"rgb("+n.r+","+n.g+","+n.b+")":"none";o.css("background-color",c),e&&o.css({"background-image":'url("'+escapeHtml(e)+'")',"background-size":"15px 15px"}),null!==a&&d.find("span").text(a)},showHighlight:function(t,i){this.$container.find('[data-category="'+t+'"]').find('[data-id="'+i+'"]').attr("data-active",1),this.updateVisibility()},hideHighlight:function(t,i){this.$container.find('[data-category="'+t+'"]').find('[data-id="'+i+'"]').attr("data-active",0),this.updateVisibility()},updateVisibility:function(){this.$container.find('.map_legend[data-active="1"]').show(),this.$container.find('.map_legend[data-active="0"]').hide();var t=this,i=0;$.each([this.CATEGORY_STANDARD,this.CATEGORY_TRIBAL,this.CATEGORY_OWN,this.CATEGORY_OTHER],function(a,n){t.countActiveHighlights(n)<1?t.hideCategory(n):(t.showCategory(n),i++)}),i<2?this.hideCategoryLabels():this.showCategoryLabels()},showCategory:function(t){this.$container.find('[data-category="'+t+'"]').show()},hideCategory:function(t){this.$container.find('[data-category="'+t+'"]').hide()},showCategoryLabels:function(){this.$container.find("tr td:first-child").show()},hideCategoryLabels:function(){this.$container.find("tr td:first-child").hide()},countActiveHighlights:function(t){return this.$container.find('[data-category="'+t+'"]').find('.map_legend[data-active="1"]').length}}}();

;/**** game/AttackPlanner.js_ ****/
var AttackPlanner;!function(){"use strict";AttackPlanner=function(){var a,e={select:null,map_mover:null},t=[0,0,0,0];function r(e,t){$(".attack-planner").html(e.html),e.message&&UI.SuccessMessage(e.message),e.map_info&&(a=0===e.map_info.length?{}:Object.assign(e.map_info),TWMap.attackPlannerMode=t,TWMap.reload(!1)),$(".attack-planner-edit-order").click(function(a){a.preventDefault(),TribalWars.post("map",{ajax:"attack_planner_edit_form"},{order_id:$(this).data("order-id")},function(a){var e;r(a,2),(e=$(".attack-planner-edit-form form"))&&(e.submit(function(a){if(a.preventDefault(),$(".attack-order-submit").hasClass("btn-disabled"))return!1;$(".attack-order-submit, .attack-order-cancel").addClass("btn-disabled"),TribalWars.post("map",{ajax:"attack_planner_edit"},e.serialize(),function(a){a.errors?n(a.errors):(TWMap.attackPlannerGeneration++,r(a,1)),$(".attack-order-submit, .attack-order-cancel").removeClass("btn-disabled")},function(){$(".attack-order-submit, .attack-order-cancel").removeClass("btn-disabled")})}),c())})}),$(".attack-planner-delete-order").click(function(a){a.preventDefault();var e=$(this),t=[{text:_("75f128539caa5408392f566fb12bdb5d"),callback:function(){TribalWars.post("map",{ajax:"attack_planner_delete"},{order_id:e.data("order-id")},function(a){TWMap.attackPlannerGeneration++,r(a,1)})},confirm:!0},{text:_("ea4788705e6873b424c65e91c2846b19"),callback:function(){},cancel:!0}];UI.ConfirmationBox(_("09fb2c3f1f8b29d225e1a9ad768a8057"),t,"confirmation-box",!0)}),$(".attack-planner-new-order").click(function(){TribalWars.get("map",{ajax:"attack_planner_new_form"},function(a){var e;r(a,2),(e=$(".attack-planner-new-form form"))&&(UnitPopup.initLinks(),e.submit(function(a){if(a.preventDefault(),$(".attack-order-submit").hasClass("btn-disabled"))return!1;TribalWars.post("map",{ajax:"attack_planner_new"},e.serialize(),function(a){a.errors?n(a.errors):(TWMap.attackPlannerGeneration++,r(a,1)),$(".attack-order-submit, .attack-order-cancel").removeClass("btn-disabled")},function(){$(".attack-order-submit, .attack-order-cancel").removeClass("btn-disabled")})}),c())})}),$(".attack-planner-export-order").click(function(){TribalWars.post("map",{ajax:"attack_planner_export_order"},{order_id:$(this).data("order-id")},function(a){Dialog.close(!1),Dialog.show("help",a.export),$("#attack-planner-copy").click(function(){var a=$("#attack-planner-export-order");navigator.clipboard?navigator.clipboard.writeText(a.val()):(a.focus(),a.select(),document.execCommand("copy"))})})}),$(".attack-planner-order-name").click(function(){$("#attack-planner-detail-"+$(this).data("order-id")).toggle(),$(this).find(".slide-up, .slide-down").toggle()}),$("#attack-planner-sort").change(function(){var a=$(this).val();TribalWars.post("map",{ajax:"attack_planner"},{sort:a},function(a){r(a,1)})}),TWMap.map.mover.preventDrag(!1),$(".premium_direct_buy").length>0&&Premium.directBuy.init()}function n(a){var e=$(".attack-planner-errors");e.html(""),$.each(a,function(a,t){e.append("<p>"+t+"</p>")}),e.append("<hr />")}function c(){$(".attack-order-cancel").click(function(a){a.preventDefault(),$(".attack-order-cancel").hasClass("btn-disabled")||TribalWars.get("map",{ajax:"attack_planner"},function(a){r(a,1)})}),$("#order_villages").change(function(){var e=$(this).val().split(",");a={},$.each(e,function(e,t){var r=t.split("|"),n=1e3*parseInt(r[0])+parseInt(r[1]);if(TWMap.villages[n]&&"ghost"!=TWMap.villages[n].special){var c=TWMap.villages[n];a[c.id]={x:parseInt(r[0]),y:parseInt(r[1])}}}),$("#order-villages-count").html(Object.keys(a).length),TWMap.reload(!1)}),$("#order_arrival_time").Zebra_DatePicker({format:"d.m.Y H:i:s",direction:!0,readonly_element:!1,show_icon:!1,show_select_today:_("1dd1c5fb7f25cd41b291d43a89e3aefd"),lang_clear_date:_("4239f67c37eed41d01bce841e2409c08"),days:[_("9d1a0949c39e66a0cd65240bc0ac9177"),_("6f8522e0610541f1ef215a22ffa66ff6"),_("5792315f09a5d54fb7e3d066672b507f"),_("796c163589f295373e171842f37265d5"),_("78ae6f0cd191d25147e252dc54768238"),_("c33b138a163847cdb6caeeb7c9a126b4"),_("8b7051187b9191cdcdae6ed5a10e5adc")],months:[_("86f5978d9b80124f509bdb71786e929e"),_("659e59f062c75f81259d22786d6c44aa"),_("fa3e5edac607a88d8fd7ecb9d6d67424"),_("3fcf026bbfffb63fb24b8de9d0446949"),_("195fbb57ffe7449796d23466085ce6d8"),_("688937ccaf2a2b0c45a1c9bbba09698d"),_("1b539f6f34e8503c97f6d3421346b63c"),_("41ba70891fb6f39327d8ccb9b1dafb84"),_("cc5d90569e1c8313c2b1c2aab1401174"),_("eca60ae8611369fe28a02e2ab8c5d12e"),_("7e823b37564da492ca1629b4732289a8"),_("82331503174acbae012b2004f6431fa5")]}),$("#order_players_select_all").click(function(){$(".order_players").prop("checked",$(this).is(":checked"))}),$("#order_allow_repeats").change(function(){$("#order_repeats").prop("disabled",!$(this).is(":checked"))}),function(){e.map_mover=$("#map_mover"),e.select=(r=$("<div/>"),r.css({height:"100%",width:"100%","z-index":"10","background-image":e.map_mover.css("background-image"),position:"absolute",left:"0px",top:"0px"}).attr("id","attack-planner-selection").hide(),r.insertAfter("#map_mover"),r),TWMap.map.mover.preventDrag(jQuery.proxy(function(a,r){var n=[r[0]-a[0],r[1]-a[1]],c=e.map_mover.offset();c.left-=$(window).scrollLeft(),c.top-=$(window).scrollTop(),a=[a[0]-c.left,a[1]-c.top],n[0]<0&&(a[0]+=n[0],n[0]=-n[0]),n[1]<0&&(a[1]+=n[1],n[1]=-n[1]),t=[a[0],a[1],a[0]+n[0],a[1]+n[1]],e.select.height(n[1]).width(n[0]).css({top:a[1]+"px",left:a[0]+"px"})},this),jQuery.proxy(function(){e.select.css({height:"0px",width:"0px"}).show()},this),jQuery.proxy(function(){var r,n;e.select.hide(),r=(t[0]+TWMap.map.pos[0])/TWMap.map.scale[0],n=(t[1]+TWMap.map.pos[1])/TWMap.map.scale[1];var c=[~~r,~~n];r=(t[2]+TWMap.map.pos[0])/TWMap.map.scale[0],n=(t[3]+TWMap.map.pos[1])/TWMap.map.scale[1];var i=[~~r,~~n];for(r=c[0];r<=i[0];r++)for(n=c[1];n<=i[1];n++){var l=1e3*r+n,d=TWMap.villages[l];d&&"ghost"!=d.special&&(a[d.id]?delete a[d.id]:a[d.id]={x:r,y:n})}o(),TWMap.reload(!1)},this));var r}()}function o(){var e=[];$.each(a,function(a,t){e.push(t.x+"|"+t.y)}),$("#order_villages").val(e.join()),$("#order-villages-count").html(e.length)}return{getMapInfo:function(){return a},init:function(){$("#attack_planner_enabled").is(":checked")?TribalWars.get("map",{ajax:"attack_planner"},function(a){TWMap.attackPlannerGeneration++,r(a,1)}):($(".attack-planner").html(""),TWMap.attackPlannerMode&&(TWMap.attackPlannerMode=!1,TWMap.reload(!1)))},onVillageClicked:function(e,t,r){if("ghost"==TWMap.villages[1e3*t+r].special)return!1;a[e]?delete a[e]:a[e]={x:t,y:r},o(),TWMap.reload(!1)}}}()}();

;